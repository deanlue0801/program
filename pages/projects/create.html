<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°å¢å°ˆæ¡ˆ - å°ˆæ¡ˆç®¡ç†ç³»çµ±</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif; background: #f5f6fa; line-height: 1.6; }
        .navbar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .nav-container { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; }
        .nav-left { display: flex; align-items: center; gap: 30px; }
        .logo { display: flex; align-items: center; gap: 10px; font-size: 1.3rem; font-weight: bold; text-decoration: none; color: white; }
        .breadcrumb { display: flex; align-items: center; gap: 10px; color: rgba(255,255,255,0.8); font-size: 0.9rem; }
        .breadcrumb a { color: rgba(255,255,255,0.8); text-decoration: none; transition: color 0.3s; }
        .breadcrumb a:hover { color: white; }
        .nav-right { display: flex; align-items: center; gap: 20px; }
        .user-info { display: flex; align-items: center; gap: 10px; color: white; }
        .back-btn { background: rgba(255,255,255,0.1); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-family: inherit; text-decoration: none; display: flex; align-items: center; gap: 8px; }
        .back-btn:hover { background: rgba(255,255,255,0.2); }
        .main-container { max-width: 800px; margin: 0 auto; padding: 30px 20px; }
        .page-header { text-align: center; margin-bottom: 40px; }
        .page-title { font-size: 2.2rem; color: #333; margin-bottom: 10px; }
        .page-subtitle { color: #666; font-size: 1.1rem; }
        .form-container { background: white; border-radius: 15px; padding: 40px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); position: relative; overflow: hidden; }
        .form-container::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #667eea, #764ba2); }
        .form-section { margin-bottom: 35px; }
        .section-title { font-size: 1.3rem; color: #333; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 20px; }
        .form-group { margin-bottom: 25px; }
        .form-label { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 0.95rem; }
        .required { color: #e74c3c; font-weight: bold; }
        .form-input { width: 100%; padding: 15px 18px; border: 2px solid #e1e5e9; border-radius: 10px; font-size: 16px; transition: all 0.3s ease; background: #fafbfc; font-family: inherit; }
        .form-input:focus { outline: none; border-color: #667eea; background: white; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2); }
        .form-textarea { height: 120px; resize: vertical; font-family: inherit; }
        .currency-input { position: relative; }
        .currency-symbol { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: #666; font-weight: bold; z-index: 1; }
        .currency-input .form-input { padding-left: 45px; }
        .form-hint { font-size: 0.85rem; color: #666; margin-top: 5px; display: flex; align-items: center; gap: 5px; }
        .form-error { font-size: 0.85rem; color: #e74c3c; margin-top: 5px; display: none; }
        .form-actions { display: flex; gap: 15px; justify-content: center; margin-top: 40px; padding-top: 30px; border-top: 2px solid #f0f0f0; }
        .btn { padding: 15px 30px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: inline-flex; align-items: center; gap: 10px; min-width: 140px; justify-content: center; }
        .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3); }
        .btn-secondary { background: #f8f9fa; color: #666; border: 2px solid #e1e5e9; }
        .btn-secondary:hover { background: #e9ecef; border-color: #adb5bd; }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .loading-spinner { width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .success-message, .error-message { padding: 15px 20px; border-radius: 10px; margin-bottom: 20px; display: none; align-items: center; gap: 10px; }
        .success-message { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
        .error-message { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
        @media (max-width: 768px) {
            .nav-container { padding: 10px 15px; }
            .main-container { padding: 20px 15px; }
            .form-container { padding: 25px 20px; }
            .form-grid { grid-template-columns: 1fr; gap: 20px; }
            .page-title { font-size: 1.8rem; }
            .form-actions { flex-direction: column; }
            .btn { width: 100%; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-left">
                <a href="javascript:void(0)" onclick="goToDashboard()" class="logo">
                    <span>ğŸ—ï¸</span>
                    <span>å°ˆæ¡ˆç®¡ç†ç³»çµ±</span>
                </a>
                <div class="breadcrumb">
                    <a href="javascript:void(0)" onclick="goToDashboard()">é¦–é </a>
                    <span>â€º</span>
                    <a href="list.html">å°ˆæ¡ˆç®¡ç†</a>
                    <span>â€º</span>
                    <span id="pageMode">æ–°å¢å°ˆæ¡ˆ</span>
                </div>
            </div>
            <div class="nav-right">
                <div class="user-info">
                    <span>ğŸ‘¤</span>
                    <span id="currentUser">è¼‰å…¥ä¸­...</span>
                </div>
                <a href="list.html" class="back-btn">
                    <span>â†</span>
                    <span>è¿”å›åˆ—è¡¨</span>
                </a>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <div class="page-header">
            <h1 class="page-title" id="pageTitle">ğŸš€ æ–°å¢å°ˆæ¡ˆ</h1>
            <p class="page-subtitle" id="pageSubtitle">å»ºç«‹æ–°çš„å»ºç¯‰å·¥ç¨‹å°ˆæ¡ˆ</p>
        </div>

        <div class="form-container">
            <div id="successMessage" class="success-message">
                <span>âœ…</span>
                <span id="successText"></span>
            </div>
            <div id="errorMessage" class="error-message">
                <span>âŒ</span>
                <span id="errorText"></span>
            </div>

            <form id="projectForm" action="javascript:void(0);">
                <div class="form-section">
                    <h3 class="section-title"><span>ğŸ“‹</span>åŸºæœ¬è³‡è¨Š</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label"><span>ğŸ·ï¸</span>å°ˆæ¡ˆåç¨±<span class="required">*</span></label>
                            <input type="text" id="projectName" class="form-input" placeholder="ä¾‹ï¼šå°åŒ—å¸‚ä¿¡ç¾©å€å•†æ¥­å¤§æ¨“" required>
                            <div class="form-error" id="projectNameError"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label"><span>ğŸ”¢</span>å°ˆæ¡ˆç·¨è™Ÿ<span class="required">*</span></label>
                            <input type="text" id="projectCode" class="form-input" placeholder="ä¾‹ï¼šPROJ-2024-001" required>
                             <div class="form-error" id="projectCodeError"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label"><span>ğŸ“</span>å°ˆæ¡ˆæè¿°</label>
                        <textarea id="projectDescription" class="form-input form-textarea" placeholder="è«‹æè¿°å°ˆæ¡ˆçš„è©³ç´°å…§å®¹..."></textarea>
                    </div>
                </div>

                <div class="form-section">
                    <h3 class="section-title"><span>ğŸ’°</span>å°ˆæ¡ˆè¦æ¨¡</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label"><span>ğŸ’µ</span>å°ˆæ¡ˆé ç®—<span class="required">*</span></label>
                            <div class="currency-input">
                                <span class="currency-symbol">NT$</span>
                                <input type="number" id="projectBudget" class="form-input" placeholder="0" required min="0">
                            </div>
                             <div class="form-error" id="projectBudgetError"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label"><span>ğŸ“Š</span>å°ˆæ¡ˆç‹€æ…‹</label>
                            <select id="projectStatus" class="form-input form-select">
                                <option value="planning">è¦åŠƒä¸­</option>
                                <option value="ready">æº–å‚™é–‹å§‹</option>
                                <option value="active">é€²è¡Œä¸­</option>
                                <option value="paused">æš«åœ</option>
                                <option value="completed">å·²å®Œæˆ</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <a href="list.html" class="btn btn-secondary"><span>âŒ</span>å–æ¶ˆ</a>
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <span class="loading-spinner" id="loadingSpinner"></span>
                        <span id="submitText"><span>ğŸ’¾</span>å»ºç«‹å°ˆæ¡ˆ</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let app, auth, db, currentUser;
        let isEditMode = false;
        let editProjectId = null;

        // é é¢è¼‰å…¥å®Œæˆå¾Œï¼ŒåŸ·è¡Œæ‰€æœ‰åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM å·²è¼‰å…¥ï¼Œé–‹å§‹åˆå§‹åŒ– Firebase...');
            try {
                app = firebase.initializeApp({
                    apiKey: "AIzaSyDV26PsFl_nH9SkfQAYgbCPjbanDluFrvo",
                    authDomain: "project-management-syste-4c9ce.firebaseapp.com",
                    projectId: "project-management-syste-4c9ce",
                    storageBucket: "project-management-syste-4c9ce.firebasestorage.app",
                    messagingSenderId: "153223609209",
                    appId: "1:153223609209:web:f4504f7ac52fc76b910da8"
                });
                auth = firebase.auth();
                db = firebase.firestore();

                auth.onAuthStateChanged(user => {
                    if (user) {
                        currentUser = user;
                        console.log('ä½¿ç”¨è€…å·²ç™»å…¥:', currentUser.email);
                        setupPage();
                    } else {
                        console.log('ä½¿ç”¨è€…æœªç™»å…¥ï¼Œå°‡è·³è½‰...');
                        window.location.href = '../../login_page.html';
                    }
                });
            } catch (error) {
                console.error('Firebase åˆå§‹åŒ–å¤±æ•—:', error);
                showError('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
            }
        });

        function setupPage() {
            updateUserInfo(currentUser);
            checkEditModeAndLoadData();
            bindEvents();
        }
        
        function updateUserInfo(user) {
            document.getElementById('currentUser').textContent = user.email;
        }

        function checkEditModeAndLoadData() {
            const urlParams = new URLSearchParams(window.location.search);
            editProjectId = urlParams.get('edit');
            
            if (editProjectId) {
                isEditMode = true;
                document.getElementById('pageTitle').textContent = 'âœï¸ ç·¨è¼¯å°ˆæ¡ˆ';
                document.getElementById('submitText').innerHTML = '<span>ğŸ’¾</span><span>æ›´æ–°å°ˆæ¡ˆ</span>';
                loadProjectForEdit(editProjectId);
            } else {
                isEditMode = false;
                generateProjectCode();
            }
        }

        async function loadProjectForEdit(projectId) {
            try {
                const doc = await db.collection('projects').doc(projectId).get();
                if (!doc.exists) {
                    showError('æ‰¾ä¸åˆ°æŒ‡å®šçš„å°ˆæ¡ˆ');
                    setTimeout(() => window.location.href = 'list.html', 2000);
                    return;
                }
                const project = doc.data();
                fillFormWithProject(project);
            } catch (error) {
                console.error('è¼‰å…¥å°ˆæ¡ˆè³‡æ–™å¤±æ•—:', error);
                showError('è¼‰å…¥å°ˆæ¡ˆè³‡æ–™å¤±æ•—: ' + error.message);
            }
        }

        function fillFormWithProject(project) {
            document.getElementById('projectName').value = project.projectName || ''; 
            document.getElementById('projectCode').value = project.projectCode || ''; 
            document.getElementById('projectDescription').value = project.description || '';
            document.getElementById('projectBudget').value = project.budget || '';
            document.getElementById('projectStatus').value = project.status || 'planning';
        }

        function generateProjectCode() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const time = String(now.getHours()).padStart(2, '0') + String(now.getMinutes()).padStart(2, '0');
            document.getElementById('projectCode').value = `PROJ-${year}${month}${day}-${time}`;
        }

        function bindEvents() {
            document.getElementById('projectForm').addEventListener('submit', handleSubmit);
        }

        async function handleSubmit(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('submitText').innerHTML = isEditMode ? '<span>â³</span><span>æ›´æ–°ä¸­...</span>' : '<span>â³</span><span>å»ºç«‹ä¸­...</span>';

            try {
                const projectData = collectFormData();
                if (isEditMode) {
                    await updateProject(editProjectId, projectData);
                } else {
                    await saveProject(projectData);
                }
            } catch (error) {
                console.error('æ“ä½œå¤±æ•—:', error);
                showError('æ“ä½œå¤±æ•—: ' + error.message);
                resetSubmitButton();
            }
        }

        function collectFormData() {
            const baseData = {
                projectName: document.getElementById('projectName').value.trim(),
                projectCode: document.getElementById('projectCode').value.trim(),
                description: document.getElementById('projectDescription').value.trim(),
                budget: parseFloat(document.getElementById('projectBudget').value) || 0,
                status: document.getElementById('projectStatus').value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            if (!isEditMode) {
                baseData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                baseData.members = [{ email: currentUser.email, role: 'owner' }];
                baseData.memberEmails = [currentUser.email];
            }
            return baseData;
        }

        async function saveProject(projectData) {
            const codeQuery = await db.collection('projects').where('projectCode', '==', projectData.projectCode).get();
            if (!codeQuery.empty) throw new Error('å°ˆæ¡ˆç·¨è™Ÿå·²å­˜åœ¨ï¼Œè«‹ä½¿ç”¨å…¶ä»–ç·¨è™Ÿ');
            
            await db.collection('projects').add(projectData);
            showSuccess('å°ˆæ¡ˆå»ºç«‹æˆåŠŸï¼');
            setTimeout(() => window.location.href = 'list.html', 2000);
        }

        async function updateProject(projectId, projectData) {
            await db.collection('projects').doc(projectId).update(projectData);
            showSuccess('å°ˆæ¡ˆæ›´æ–°æˆåŠŸï¼');
            setTimeout(() => window.location.href = 'list.html', 2000);
        }

        function goToDashboard() {
            window.location.href = '../dashboard.html';
        }

        function resetSubmitButton() {
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = false;
            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('submitText').innerHTML = isEditMode ? '<span>ğŸ’¾</span><span>æ›´æ–°å°ˆæ¡ˆ</span>' : '<span>ğŸ’¾</span><span>å»ºç«‹å°ˆæ¡ˆ</span>';
        }

        function showSuccess(message) {
            const successMsg = document.getElementById('successMessage');
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successText').textContent = message;
            successMsg.style.display = 'flex';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showError(message) {
            const errorMsg = document.getElementById('errorMessage');
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('errorText').textContent = message;
            errorMsg.style.display = 'flex';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>
</html>
