<script>
function initProjectCreatePage() {
    const form = document.getElementById('projectForm');
    const submitBtn = document.getElementById('submitBtn');
    if (!form || !submitBtn || form.dataset.initialized) return;
    form.dataset.initialized = 'true';

    const auth = firebase.auth();
    const db = firebase.firestore();

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const currentUser = auth.currentUser;
        if (!currentUser) return alert("錯誤：使用者未登入，無法執行操作。");

        submitBtn.disabled = true;
        submitBtn.textContent = '建立中...';

        try {
            // 【結構修正】members 欄位現在是 Map 物件
            const projectData = {
                name: document.getElementById('projectName').value.trim(),
                code: document.getElementById('projectCode').value.trim(),
                status: document.getElementById('projectStatus').value,
                budget: parseFloat(document.getElementById('projectBudget').value) || 0,
                description: document.getElementById('projectDescription').value.trim(),
                createdBy: currentUser.email,
                memberEmails: [currentUser.email], // 用於高效查詢
                members: { // 以 Email 為鍵的 Map
                    [currentUser.email]: { role: 'owner' }
                },
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (!projectData.name || !projectData.code) throw new Error("專案名稱和編號為必填項。");

            await db.collection('projects').add(projectData);
            alert('專案建立成功！');
            navigateTo('/program/projects/list');
        } catch (error) {
            console.error("Create Page: 建立專案時捕獲到錯誤:", error);
            alert(`建立失敗: ${error.message}`);
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = '建立專案';
        }
    });
}
</script>
