<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æ–°å¢å°ˆæ¡ˆ</title>
    <style>
        .page-header { text-align: center; margin-bottom: 2rem; }
        .page-title { font-size: 2rem; color: #333; }
        .page-subtitle { color: #666; }
        .form-container { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-actions { text-align: right; margin-top: 2rem; border-top: 1px solid #f0f0f0; padding-top: 1.5rem; display: flex; justify-content: flex-end; gap: 1rem;}
        .required { color: #dc3545; }
        .form-input, .form-select, .form-textarea { width: 100%; } /* ç¢ºä¿èˆ‡æ‚¨ç³»çµ±æ¨£å¼ç›¸å®¹ */
    </style>
</head>
<body>
    <div class="page-header">
        <h1 class="page-title" id="pageTitle">ğŸš€ æ–°å¢å°ˆæ¡ˆ</h1>
        <p class="page-subtitle" id="pageSubtitle">å»ºç«‹æ–°çš„å»ºç¯‰å·¥ç¨‹å°ˆæ¡ˆ</p>
    </div>

    <div class="form-container">
        <div id="message-area"></div>

        <form id="projectForm" action="javascript:void(0);">
            <div class="form-section">
                <h3 class="section-title"><span>ğŸ“‹</span> åŸºæœ¬è³‡è¨Š</h3>
                <div class="form-group">
                    <label for="projectName" class="form-label">å°ˆæ¡ˆåç¨± <span class="required">*</span></label>
                    <input type="text" id="projectName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="projectCode" class="form-label">å°ˆæ¡ˆç·¨è™Ÿ <span class="required">*</span></label>
                    <input type="text" id="projectCode" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="projectStatus" class="form-label">å°ˆæ¡ˆç‹€æ…‹</label>
                    <select id="projectStatus" class="form-control">
                        <option value="planning" selected>è¦åŠƒä¸­</option>
                        <option value="active">é€²è¡Œä¸­</option>
                        <option value="completed">å·²å®Œæˆ</option>
                        <option value="paused">æš«åœ</option>
                    </select>
                </div>
            </div>

            <div class="form-section">
                <h3 class="section-title"><span>ğŸ’°</span> å°ˆæ¡ˆè¦æ¨¡</h3>
                 <div class="form-group">
                    <label for="projectBudget" class="form-label">å°ˆæ¡ˆé ç®—</label>
                    <input type="number" id="projectBudget" class="form-control" placeholder="0" min="0">
                </div>
            </div>

            <div class="form-section">
                <h3 class="section-title"><span>ğŸ“</span> å°ˆæ¡ˆæè¿°</h3>
                <div class="form-group">
                    <textarea id="projectDescription" class="form-control" rows="4" placeholder="è«‹è¼¸å…¥å°ˆæ¡ˆçš„è©³ç´°å…§å®¹..."></textarea>
                </div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="navigateTo('/program/tenders/list')">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary" id="submitBtn">å»ºç«‹å°ˆæ¡ˆ</button>
            </div>
        </form>
    </div>

<script>
function initProjectCreatePage() {
    console.log("ğŸš€ åˆå§‹åŒ–æ–°å¢å°ˆæ¡ˆé é¢ (åµéŒ¯æ¨¡å¼)...");

    const form = document.getElementById('projectForm');
    const submitBtn = document.getElementById('submitBtn');

    if (!form || !submitBtn) {
        console.error("åš´é‡éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°å¿…è¦çš„è¡¨å–®å…ƒç´ ã€‚");
        return;
    }
    
    if (typeof firebase === 'undefined' || !firebase.auth().currentUser) {
        console.error("Firebase æˆ–ç”¨æˆ¶å°šæœªæº–å‚™å¥½ã€‚");
        alert("éŒ¯èª¤ï¼šç„¡æ³•ç²å–ä½¿ç”¨è€…è³‡è¨Šï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚");
        return;
    }
    
    const auth = firebase.auth();
    const db = firebase.firestore();

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const currentUser = auth.currentUser;
        if (!currentUser) {
            alert("éŒ¯èª¤ï¼šä½¿ç”¨è€…æœªç™»å…¥ï¼Œç„¡æ³•åŸ·è¡Œæ“ä½œã€‚");
            return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'å»ºç«‹ä¸­...';

        try {
            const projectData = {
                name: document.getElementById('projectName').value.trim(),
                code: document.getElementById('projectCode').value.trim(),
                status: document.getElementById('projectStatus').value,
                budget: parseFloat(document.getElementById('projectBudget').value) || 0,
                description: document.getElementById('projectDescription').value.trim(),
                createdBy: currentUser.email,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (!projectData.name || !projectData.code) {
                throw new Error("å°ˆæ¡ˆåç¨±å’Œç·¨è™Ÿç‚ºå¿…å¡«é …ã€‚");
            }
            
            // ================== âœ¨ é—œéµåµéŒ¯é» âœ¨ ==================
            console.log("æº–å‚™å¯«å…¥è³‡æ–™åº«çš„æ•¸æ“šï¼š", projectData);
            
            const docRef = await db.collection('projects').add(projectData);
            
            // å¦‚æœç¨‹å¼èƒ½è·‘åˆ°é€™è£¡ï¼Œå°±ä»£è¡¨å»ºç«‹æˆåŠŸäº†ï¼
            console.log("âœ…âœ…âœ… **é‡å¤§ç™¼ç¾ï¼šå°ˆæ¡ˆå»ºç«‹æˆåŠŸï¼** âœ…âœ…âœ…");
            console.log("æ–°çš„å°ˆæ¡ˆæ–‡ä»¶ ID æ˜¯ï¼š", docRef.id);
            alert(`åµéŒ¯æç¤ºï¼šå°ˆæ¡ˆå»ºç«‹æˆåŠŸï¼\næ–‡ä»¶ID: ${docRef.id}\n\né é¢å°‡åœ¨ 3 ç§’å¾Œè·³è½‰...`);
            // ========================================================
            
            // å»¶é² 3 ç§’å¾Œå†è·³è½‰ï¼Œçµ¦æˆ‘å€‘è¶³å¤ æ™‚é–“çœ‹è¨Šæ¯
            setTimeout(() => {
                navigateTo('/program/tenders/list');
            }, 3000);

        } catch (error) {
            // å¦‚æœ Firestore çš„å®‰å…¨è¦å‰‡é˜»æ“‹äº†å¯«å…¥ï¼ŒéŒ¯èª¤æœƒåœ¨é€™è£¡è¢«æ•æ‰åˆ°
            console.error("âŒâŒâŒ **å»ºç«‹å°ˆæ¡ˆæ™‚æ•ç²åˆ°éŒ¯èª¤** âŒâŒâŒ:", error);
            alert(`å»ºç«‹å¤±æ•—: ${error.message}`);
            submitBtn.disabled = false;
            submitBtn.textContent = 'å»ºç«‹å°ˆæ¡ˆ';
        }
    });

    console.log("æ–°å¢å°ˆæ¡ˆé é¢äº‹ä»¶ç¶å®šå®Œæˆ (åµéŒ¯æ¨¡å¼)ã€‚");
}
</script>
</body>
</html>
