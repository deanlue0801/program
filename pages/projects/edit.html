/**
 * ç·¨è¼¯å°ˆæ¡ˆé é¢ (projects-edit.js) - v3.0 (æ¬Šé™ Map çµæ§‹)
 * å¯¦ç¾äº†æˆå“¡ç®¡ç†ä»‹é¢ã€æ“ä½œé‚è¼¯èˆ‡æ¬Šé™å®ˆè¡›åŠŸèƒ½ã€‚
 */
function initProjectEditPage() {
    console.log("ğŸš€ åˆå§‹åŒ–ç·¨è¼¯å°ˆæ¡ˆé é¢ (v3.0)...");

    // --- å…¨åŸŸè®Šæ•¸èˆ‡ç‹€æ…‹ç®¡ç† ---
    let projectId = null;
    let currentProjectData = {}; // å„²å­˜ç•¶å‰å°ˆæ¡ˆçš„å®Œæ•´è³‡æ–™
    let currentUserRole = null; // å„²å­˜ç•¶å‰ç™»å…¥è€…çš„è§’è‰²

    // --- DOM å…ƒç´ å¿«å– ---
    const form = document.getElementById('projectEditForm');
    const pageTitleEl = document.querySelector('.page-title');
    const permissionAlert = document.getElementById('permissionAlert');
    const memberManagementSection = document.getElementById('memberManagementSection');
    const membersTableBody = document.getElementById('membersTableBody');
    const newMemberEmailInput = document.getElementById('newMemberEmail');
    const newMemberRoleSelect = document.getElementById('newMemberRole');
    const permissionsContainer = document.getElementById('permissionsContainer');
    const addMemberBtn = document.getElementById('addMemberBtn');
    const saveChangesBtn = document.getElementById('saveChangesBtn');
    const cancelBtn = document.getElementById('cancelBtn');


    // --- ä¸»è¦æµç¨‹ ---
    async function loadPageData() {
        showLoading(true);
        const urlParams = new URLSearchParams(window.location.search);
        projectId = urlParams.get('id');

        if (!projectId) {
            showAlert('ç„¡æ•ˆçš„å°ˆæ¡ˆID', 'error');
            return navigateTo('/program/projects/list');
        }

        try {
            const projectDoc = await db.collection('projects').doc(projectId).get();
            if (!projectDoc.exists) {
                showAlert('æ‰¾ä¸åˆ°æŒ‡å®šçš„å°ˆæ¡ˆ', 'error');
                return navigateTo('/program/projects/list');
            }
            
            currentProjectData = { id: projectDoc.id, ...projectDoc.data() };
            
            // æ¬Šé™æª¢æŸ¥ï¼šä½¿ç”¨è€…æ˜¯å¦ç‚ºæˆå“¡
            if (!currentProjectData.memberEmails.includes(auth.currentUser.email)) {
                showAlert('æ‚¨æ²’æœ‰æ¬Šé™æŸ¥çœ‹æ­¤å°ˆæ¡ˆ', 'error');
                return navigateTo('/program/projects/list');
            }

            populateForm(currentProjectData);
            renderMembersTable();
            setupEventListeners();
            setupUIPermissions();
            
            showLoading(false);

        } catch (error) {
            console.error("è¼‰å…¥å°ˆæ¡ˆè³‡æ–™å¤±æ•—:", error);
            showAlert("è¼‰å…¥å°ˆæ¡ˆè³‡æ–™å¤±æ•—: " + error.message, "error");
            showLoading(false);
        }
    }

    // --- æ¬Šé™æª¢æŸ¥èˆ‡ UI è¨­å®š ---
    function setupUIPermissions() {
        // ã€çµæ§‹ä¿®æ­£ã€‘ç›´æ¥å¾ Map ä¸­å–å¾—ä½¿ç”¨è€…è³‡è¨Š
        const userMemberInfo = currentProjectData.members[auth.currentUser.email];
        currentUserRole = userMemberInfo ? userMemberInfo.role : null;

        // åªæœ‰ owner æ‰èƒ½ç·¨è¼¯
        const canEdit = currentUserRole === 'owner';
        
        console.log(`[æ¬Šé™] ä½¿ç”¨è€…è§’è‰²: ${currentUserRole}, æ˜¯å¦å¯ç·¨è¼¯: ${canEdit}`);

        if (!canEdit) {
            // ç¦ç”¨æ‰€æœ‰è¡¨å–®å…ƒç´ 
            form.querySelectorAll('input, select, textarea').forEach(el => el.disabled = true);
            // éš±è—å„²å­˜æŒ‰éˆ•å’Œæˆå“¡ç®¡ç†å€å¡Š
            saveChangesBtn.style.display = 'none';
            memberManagementSection.style.display = 'none';
            // é¡¯ç¤ºæ¬Šé™ä¸è¶³çš„æç¤º
            permissionAlert.style.display = 'block';
        } else {
            // ç¢ºä¿æœ‰æ¬Šé™æ™‚ï¼Œæ‰€æœ‰æ±è¥¿éƒ½æ˜¯å¯è¦‹ä¸”å¯ç”¨çš„
            form.querySelectorAll('input, select, textarea').forEach(el => el.disabled = false);
            saveChangesBtn.style.display = 'inline-block';
            memberManagementSection.style.display = 'block';
            permissionAlert.style.display = 'none';
        }
    }

    // --- UI æ¸²æŸ“ ---
    function populateForm(project) {
        if (pageTitleEl) pageTitleEl.textContent = `âœï¸ ç·¨è¼¯å°ˆæ¡ˆï¼š${project.name || ''}`;
        
        document.getElementById('projectName').value = project.name || '';
        document.getElementById('projectCode').value = project.code || '';
        document.getElementById('statusSelect').value = project.status || 'planning';
        const startDateEl = document.getElementById('startDate');
        if(startDateEl) startDateEl.value = safeFormatDateForInput(project.startDate);
        const endDateEl = document.getElementById('endDate');
        if(endDateEl) endDateEl.value = safeFormatDateForInput(project.endDate);
        const contractorNameEl = document.getElementById('contractorName');
        if(contractorNameEl) contractorNameEl.value = project.contractorName || '';
        const contractorContactEl = document.getElementById('contractorContact');
        if(contractorContactEl) contractorContactEl.value = project.contractorContact || '';
        const descriptionEl = document.getElementById('description');
        if(descriptionEl) descriptionEl.value = project.description || '';
        const notesEl = document.getElementById('notes');
        if(notesEl) notesEl.value = project.notes || '';
    }
    
    function renderMembersTable() {
        if (!membersTableBody) return;
        membersTableBody.innerHTML = '';
        
        // ã€çµæ§‹ä¿®æ­£ã€‘éæ­· Map ç‰©ä»¶
        for (const email in currentProjectData.members) {
            const member = currentProjectData.members[email];
            const tr = document.createElement('tr');
            const roleText = { owner: 'æ“æœ‰è€…', editor: 'ç·¨è¼¯è€…', viewer: 'æª¢è¦–è€…' }[member.role] || member.role;
            
            tr.innerHTML = `
                <td>${email}</td>
                <td><span class="status-badge ${member.role}">${roleText}</span></td>
                <td>
                    ${member.role !== 'owner' ? `<button type="button" class="btn btn-sm btn-danger" data-action="remove-member" data-email="${email}">ç§»é™¤</button>` : 'â€”'}
                </td>
            `;
            membersTableBody.appendChild(tr);
        }
    }

    // --- äº‹ä»¶ç›£è½å™¨è¨­å®š ---
    function setupEventListeners() {
        if (form.dataset.initialized) return;
        form.dataset.initialized = 'true';

        form.addEventListener('submit', handleFormSubmit);
        cancelBtn.addEventListener('click', () => navigateTo('/program/projects/list'));
        addMemberBtn.addEventListener('click', handleAddMember);
        newMemberRoleSelect.addEventListener('change', () => {
            permissionsContainer.style.display = newMemberRoleSelect.value === 'editor' ? 'block' : 'none';
        });
        
        membersTableBody.addEventListener('click', e => {
            if (e.target.dataset.action === 'remove-member') {
                handleRemoveMember(e.target.dataset.email);
            }
        });
    }

    // --- æ“ä½œè™•ç†å‡½å¼ ---
    async function handleFormSubmit(e) {
        e.preventDefault();
        
        const updatedData = {
            name: document.getElementById('projectName').value.trim(),
            code: document.getElementById('projectCode').value.trim(),
            status: document.getElementById('statusSelect').value,
            // æ³¨æ„ï¼šé€™è£¡åªæ›´æ–°å°ˆæ¡ˆåŸºæœ¬è³‡æ–™ï¼Œæˆå“¡è³‡æ–™ç”±å°ˆé–€çš„å‡½å¼è™•ç†
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        if (!updatedData.name) return showAlert("å°ˆæ¡ˆåç¨±ç‚ºå¿…å¡«é …", "error");

        try {
            showLoading(true, 'å„²å­˜ä¸­...');
            await db.collection('projects').doc(projectId).update(updatedData);
            showAlert("å°ˆæ¡ˆè³‡æ–™æ›´æ–°æˆåŠŸï¼", "success");
            navigateTo(`/program/projects/list`);
        } catch (error) {
            console.error("æ›´æ–°å°ˆæ¡ˆå¤±æ•—:", error);
            showAlert("æ›´æ–°å¤±æ•—: " + error.message, "error");
        } finally {
            showLoading(false);
        }
    }
    
    async function handleAddMember() {
        const email = newMemberEmailInput.value.trim().toLowerCase();
        const role = newMemberRoleSelect.value;
        
        if (!email) return showAlert('è«‹è¼¸å…¥æˆå“¡çš„ Email', 'warning');
        if (currentProjectData.memberEmails.includes(email)) return showAlert('è©²æˆå“¡å·²åœ¨å°ˆæ¡ˆä¸­', 'warning');

        const newMember = { role };
        if (role === 'editor') {
            newMember.permissions = {};
            permissionsContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                newMember.permissions[cb.dataset.permission] = cb.checked;
            });
        }
        
        // ã€çµæ§‹ä¿®æ­£ã€‘ç›´æ¥åœ¨ Map å’Œ Array ä¸­æ–°å¢
        const updatedMembers = { ...currentProjectData.members, [email]: newMember };
        const updatedMemberEmails = [...currentProjectData.memberEmails, email];

        try {
            showLoading(true, 'æ–°å¢æˆå“¡ä¸­...');
            await db.collection('projects').doc(projectId).update({
                members: updatedMembers,
                memberEmails: updatedMemberEmails,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            // åŒæ­¥æœ¬åœ°è³‡æ–™
            currentProjectData.members = updatedMembers;
            currentProjectData.memberEmails = updatedMemberEmails;
            showAlert('æˆå“¡æ–°å¢æˆåŠŸï¼', 'success');
            renderMembersTable();
            newMemberEmailInput.value = '';
        } catch (error) {
            console.error("æ–°å¢æˆå“¡å¤±æ•—:", error);
            showAlert("æ–°å¢æˆå“¡å¤±æ•—: " + error.message, "error");
        } finally {
            showLoading(false);
        }
    }
    
    async function handleRemoveMember(emailToRemove) {
        if (!confirm(`ç¢ºå®šè¦å¾å°ˆæ¡ˆä¸­ç§»é™¤æˆå“¡ã€Œ${emailToRemove}ã€å—ï¼Ÿ`)) return;

        // ã€çµæ§‹ä¿®æ­£ã€‘å¾ Map å’Œ Array ä¸­ç§»é™¤
        const updatedMembers = { ...currentProjectData.members };
        delete updatedMembers[emailToRemove];
        const updatedMemberEmails = currentProjectData.memberEmails.filter(e => e !== emailToRemove);
        try {
            showLoading(true, 'ç§»é™¤æˆå“¡ä¸­...');
            await db.collection('projects').doc(projectId).update({
                members: updatedMembers,
                memberEmails: updatedMemberEmails,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            // åŒæ­¥æœ¬åœ°è³‡æ–™
            currentProjectData.members = updatedMembers;
            currentProjectData.memberEmails = updatedMemberEmails;
            showAlert('æˆå“¡ç§»é™¤æˆåŠŸï¼', 'success');
            renderMembersTable();
        } catch (error) {
            console.error("ç§»é™¤æˆå“¡å¤±æ•—:", error);
            showAlert("ç§»é™¤æˆå“¡å¤±æ•—: " + error.message, "error");
            loadPageData();
        } finally {
            showLoading(false);
        }
    }

    // --- è¼”åŠ©å‡½æ•¸ ---
    function showLoading(isLoading, message = 'è™•ç†ä¸­...') {
        const loadingEl = document.getElementById('loading');
        const formEl = document.getElementById('projectEditForm');
        if (loadingEl) {
            loadingEl.style.display = isLoading ? 'flex' : 'none';
            if (loadingEl.querySelector('p')) loadingEl.querySelector('p').textContent = message;
        }
        if (formEl) {
            formEl.style.display = isLoading ? 'none' : 'block';
        }
    }

    function safeFormatDateForInput(dateField) {
        if (!dateField) return '';
        const date = dateField.toDate ? dateField.toDate() : new Date(dateField);
        if (isNaN(date.getTime())) return '';
        return date.toISOString().split('T')[0];
    }
    
    // --- å•Ÿå‹•é é¢ ---
    loadPageData();
}
