<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨™å–®ç·¨è¼¯ - å°ˆæ¡ˆç®¡ç†ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: #666;
        }

        .breadcrumb a {
            color: #667eea;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-logout { background: #ff6b6b; color: white; }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .content-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .page-title {
            font-size: 2rem;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .page-subtitle {
            color: #666;
            margin-bottom: 30px;
        }

        /* æ¨™å–®è³‡è¨Šå¡ç‰‡ */
        .tender-info-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            border-left: 4px solid #667eea;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .info-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .info-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .info-value.amount {
            color: #28a745;
        }

        .info-value.addition {
            color: #ffc107;
        }

        .info-value.total {
            color: #667eea;
            font-size: 20px;
        }

        /* é …ç›®è¡¨æ ¼æ¨£å¼ */
        .items-section {
            margin-bottom: 40px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .section-title {
            font-size: 1.4rem;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .items-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .items-table th,
        .items-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .items-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        .items-table td {
            font-size: 14px;
            vertical-align: middle;
        }

        .items-table tr:hover {
            background: #f8f9fa;
        }

        .items-table tr.readonly {
            background: #f1f3f4;
            color: #6c757d;
        }

        .original-tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .addition-tag {
            background: #fff3e0;
            color: #f57c00;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        /* çµ±è¨ˆå¡ç‰‡ */
        .summary-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .summary-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #667eea;
        }

        .summary-item-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        .summary-detail {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .summary-detail:last-child {
            margin-bottom: 0;
            padding-top: 8px;
            border-top: 1px solid #e9ecef;
            font-weight: 600;
        }

        /* è¿½åŠ é …ç›® Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .modal-title {
            font-size: 1.4rem;
            color: #333;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #000;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #495057;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .alert.warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .navbar {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <nav class="navbar">
            <div class="breadcrumb">
                <a href="javascript:void(0)" onclick="goToDashboard()">é¦–é </a>
                <span>/</span>
                <a href="list.html">æ¨™å–®ç®¡ç†</a>
                <span>/</span>
                <span>æ¨™å–®ç·¨è¼¯</span>
            </div>
            <div class="user-info">
                <span id="currentUser">è¼‰å…¥ä¸­...</span>
                <button class="btn btn-logout" onclick="logout()">ç™»å‡º</button>
            </div>
        </nav>

        <div class="content-card">
            <h1 class="page-title">ğŸ“‹ æ¨™å–®ç·¨è¼¯</h1>
            <p class="page-subtitle">ç®¡ç†åŸå§‹é …ç›®èˆ‡è¿½åŠ é …ç›®ï¼Œä¿æŒå®Œæ•´çš„è®Šæ›´æ­·å²è¨˜éŒ„</p>

            <!-- æ¨™å–®åŸºæœ¬è³‡è¨Š -->
            <div class="tender-info-section">
                <h3>ğŸ“Š æ¨™å–®è³‡è¨Š</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">æ¨™å–®åç¨±</div>
                        <div class="info-value" id="tenderName">è¼‰å…¥ä¸­...</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">æ‰¿åŒ…å•†</div>
                        <div class="info-value" id="contractorName">è¼‰å…¥ä¸­...</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">åŸå§‹åˆç´„é‡‘é¡</div>
                        <div class="info-value amount" id="originalAmount">NT$ 0</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">è¿½åŠ é‡‘é¡</div>
                        <div class="info-value addition" id="additionAmount">NT$ 0</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ç›®å‰ç¸½é‡‘é¡</div>
                        <div class="info-value total" id="totalAmount">NT$ 0</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">å¢å¹…ç™¾åˆ†æ¯”</div>
                        <div class="info-value" id="increasePercentage">0%</div>
                    </div>
                </div>
            </div>

            <!-- åŸå§‹é …ç›®æ¸…å–® -->
            <div class="items-section">
                <div class="section-header">
                    <h3 class="section-title">ğŸ“‹ åŸå§‹é …ç›® (ä¸å¯ä¿®æ”¹)</h3>
                    <div class="info-label">ç°½ç´„æ™‚çš„åŸå§‹é …ç›®ï¼Œä¿æŒåˆç´„å®Œæ•´æ€§</div>
                </div>
                
                <table class="items-table">
                    <thead>
                        <tr>
                            <th>å¤§é …ç›®</th>
                            <th>é …ç›®åç¨±</th>
                            <th>åŸå§‹æ•¸é‡</th>
                            <th>å–®ä½</th>
                            <th>åŸå§‹å–®åƒ¹</th>
                            <th>åŸå§‹å°è¨ˆ</th>
                            <th>ç›®å‰ç¸½æ•¸é‡</th>
                            <th>è¿½åŠ æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="originalItemsTable">
                        <!-- å‹•æ…‹è¼‰å…¥åŸå§‹é …ç›® -->
                    </tbody>
                </table>
            </div>

            <!-- è¿½åŠ é …ç›®æ¸…å–® -->
            <div class="items-section">
                <div class="section-header">
                    <h3 class="section-title">â• è¿½åŠ é …ç›®</h3>
                    <button class="btn btn-success" onclick="showAdditionModal()">
                        â• æ–°å¢è¿½åŠ é …ç›®
                    </button>
                </div>
                
                <table class="items-table">
                    <thead>
                        <tr>
                            <th>è¿½åŠ æ—¥æœŸ</th>
                            <th>é—œè¯é …ç›®</th>
                            <th>è¿½åŠ æ•¸é‡</th>
                            <th>è¿½åŠ å–®åƒ¹</th>
                            <th>è¿½åŠ é‡‘é¡</th>
                            <th>è¿½åŠ åŸå› </th>
                            <th>ç‹€æ…‹</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="additionItemsTable">
                        <!-- å‹•æ…‹è¼‰å…¥è¿½åŠ é …ç›® -->
                    </tbody>
                </table>
                
                <div id="noAdditionsMessage" style="text-align: center; padding: 40px; color: #6c757d; display: none;">
                    <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“</div>
                    <div>ç›®å‰æ²’æœ‰è¿½åŠ é …ç›®</div>
                    <small>é»æ“Šä¸Šæ–¹ã€Œæ–°å¢è¿½åŠ é …ç›®ã€æŒ‰éˆ•é–‹å§‹æ·»åŠ </small>
                </div>
            </div>

            <!-- ç¸½è¦½çµ±è¨ˆ -->
            <div class="summary-section">
                <h3>ğŸ“Š æ•¸é‡çµ±è¨ˆç¸½è¦½</h3>
                <div class="summary-grid" id="summaryGrid">
                    <!-- å‹•æ…‹è¼‰å…¥çµ±è¨ˆå¡ç‰‡ -->
                </div>
            </div>

            <!-- è¼‰å…¥å‹•ç•« -->
            <div id="loadingSection" class="loading">
                <div class="spinner"></div>
                <p id="loadingText">è¼‰å…¥ä¸­...</p>
            </div>

            <!-- æç¤ºè¨Šæ¯ -->
            <div id="alertMessage" class="alert"></div>
        </div>
    </div>

    <!-- è¿½åŠ é …ç›® Modal -->
    <div id="additionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">â• æ–°å¢è¿½åŠ é …ç›®</h3>
                <span class="close" onclick="closeAdditionModal()">&times;</span>
            </div>
            
            <form id="additionForm">
                <div class="form-group">
                    <label for="relatedDetailItem">é¸æ“‡é—œè¯é …ç›® <span style="color: #dc3545;">*</span></label>
                    <select id="relatedDetailItem" class="form-control" required>
                        <option value="">è«‹é¸æ“‡è¦è¿½åŠ çš„åŸå§‹é …ç›®</option>
                    </select>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="additionQuantity">è¿½åŠ æ•¸é‡ <span style="color: #dc3545;">*</span></label>
                        <input type="number" id="additionQuantity" class="form-control" min="1" required>
                    </div>
                    <div class="form-group">
                        <label for="additionUnitPrice">è¿½åŠ å–®åƒ¹ <span style="color: #dc3545;">*</span></label>
                        <input type="number" id="additionUnitPrice" class="form-control" min="0" step="0.01" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="additionReason">è¿½åŠ åŸå›  <span style="color: #dc3545;">*</span></label>
                    <textarea id="additionReason" class="form-control" rows="3" placeholder="è«‹è©³ç´°èªªæ˜è¿½åŠ çš„åŸå› ..." required></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="additionDate">è¿½åŠ æ—¥æœŸ</label>
                        <input type="date" id="additionDate" class="form-control" value="">
                    </div>
                    <div class="form-group">
                        <label for="approvedBy">æ ¸å‡†äººå“¡</label>
                        <input type="text" id="approvedBy" class="form-control" placeholder="å¯é¸å¡«">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="additionNotes">å‚™è¨»</label>
                    <textarea id="additionNotes" class="form-control" rows="2" placeholder="å…¶ä»–å‚™è¨»èªªæ˜..."></textarea>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button type="button" class="btn btn-secondary" onclick="closeAdditionModal()">
                        å–æ¶ˆ
                    </button>
                    <button type="submit" class="btn btn-success">
                        â• æ–°å¢è¿½åŠ é …ç›®
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <!-- æœ€çµ‚å¢å¼·ç‰ˆçµ±ä¸€é…ç½®æª” -->
    <script src="../assets/js/firebase-config.js"></script>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let currentTender = null;
        let originalItems = [];
        let additionItems = [];
        let majorItemsMap = new Map();
        let realtimeUnsubscribers = []; // å„²å­˜å³æ™‚ç›£è½çš„å–æ¶ˆå‡½æ•¸

        // ç²å– URL åƒæ•¸
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // åˆå§‹åŒ–æ‡‰ç”¨
        document.addEventListener('DOMContentLoaded', function() {
            initFirebase(async function(user) {
                console.log('âœ… æ¨™å–®ç·¨è¼¯åŠŸèƒ½åˆå§‹åŒ–æˆåŠŸï¼Œç”¨æˆ¶:', user.email);
                
                const tenderId = getUrlParameter('id');
                if (!tenderId) {
                    showAlert('ç¼ºå°‘æ¨™å–®IDåƒæ•¸', 'error');
                    setTimeout(() => {
                        window.location.href = 'list.html';
                    }, 2000);
                    return;
                }
                
                // è¼‰å…¥æ¨™å–®è³‡æ–™
                await loadTenderData(tenderId);
                
                // ğŸš€ è¨­å®šå³æ™‚ç›£è½
                setupRealtimeListeners(tenderId);
                
                // è¨­å®šäº‹ä»¶ç›£è½å™¨
                setupEventListeners();
            });
        });

        // ğŸ†• è¨­å®šå³æ™‚ç›£è½ï¼ˆä¿®æ­£ç‰ˆï¼‰
        function setupRealtimeListeners(tenderId) {
            console.log('ğŸ”„ è¨­å®šå³æ™‚ç›£è½... tenderId:', tenderId);
            
            // 1. ç›£è½è¿½åŠ é …ç›®è®Šæ›´ï¼ˆç°¡åŒ–æŸ¥è©¢é¿å…ç´¢å¼•å•é¡Œï¼‰
            const additionsUnsubscriber = db.collection('additionItems')
                .where('tenderId', '==', tenderId)
                .where('createdBy', '==', currentUser.email)
                .onSnapshot((snapshot) => {
                    console.log('ğŸ“¡ è¿½åŠ é …ç›®å³æ™‚æ›´æ–° - è®Šæ›´æ•¸é‡:', snapshot.docChanges().length);
                    console.log('ğŸ“¡ ç•¶å‰å¿«ç…§å¤§å°:', snapshot.size);
                    
                    let hasChanges = false;
                    
                    snapshot.docChanges().forEach((change) => {
                        const itemData = { id: change.doc.id, ...change.doc.data() };
                        console.log('ğŸ“¡ è®Šæ›´é¡å‹:', change.type, 'é …ç›®:', itemData.name);
                        
                        if (change.type === "added") {
                            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼ˆé¿å…é‡è¤‡ï¼‰
                            const existingIndex = additionItems.findIndex(item => item.id === itemData.id);
                            if (existingIndex === -1) {
                                additionItems.unshift(itemData); // æ–°å¢åˆ°é ­éƒ¨
                                console.log('â• è¿½åŠ é …ç›®å·²æ–°å¢:', itemData.name, itemData.additionQuantity);
                                hasChanges = true;
                            } else {
                                console.log('âšª é …ç›®å·²å­˜åœ¨ï¼Œè·³é:', itemData.name);
                            }
                        }
                        
                        if (change.type === "modified") {
                            const index = additionItems.findIndex(item => item.id === itemData.id);
                            if (index !== -1) {
                                additionItems[index] = itemData;
                                console.log('ğŸ“ è¿½åŠ é …ç›®å·²ä¿®æ”¹:', itemData.name, itemData.additionQuantity);
                                hasChanges = true;
                            } else {
                                // å¦‚æœæœ¬åœ°æ²’æœ‰ï¼Œç•¶ä½œæ–°å¢è™•ç†
                                additionItems.unshift(itemData);
                                console.log('â• ä¿®æ”¹æ™‚ç™¼ç¾æ–°é …ç›®ï¼Œå·²æ–°å¢:', itemData.name);
                                hasChanges = true;
                            }
                        }
                        
                        if (change.type === "removed") {
                            const originalLength = additionItems.length;
                            additionItems = additionItems.filter(item => item.id !== itemData.id);
                            if (additionItems.length < originalLength) {
                                console.log('ğŸ—‘ï¸ è¿½åŠ é …ç›®å·²åˆªé™¤:', itemData.name);
                                hasChanges = true;
                            }
                        }
                    });
                    
                    // å¼·åˆ¶æ›´æ–°é¡¯ç¤ºï¼ˆç„¡è«–æ˜¯å¦æœ‰è®Šæ›´ï¼‰
                    if (hasChanges || snapshot.docChanges().length > 0) {
                        console.log('ğŸ”„ è§¸ç™¼å³æ™‚æ›´æ–°é¡¯ç¤º (æœ‰è®Šæ›´:', hasChanges, ')');
                        updateDisplayAfterChange();
                    } else {
                        console.log('âšª ç„¡è®Šæ›´ï¼Œè·³éæ›´æ–°');
                    }
                }, (error) => {
                    console.error('âŒ è¿½åŠ é …ç›®å³æ™‚ç›£è½éŒ¯èª¤:', error);
                    console.error('âŒ éŒ¯èª¤è©³æƒ…:', error.message);
                    // å¦‚æœå³æ™‚ç›£è½å¤±æ•—ï¼Œé¡¯ç¤ºè­¦å‘Šä½†ä¸ä¸­æ–·
                    showAlert('å³æ™‚ç›£è½å¯èƒ½ä¸­æ–·ï¼Œéƒ¨åˆ†æ›´æ–°éœ€è¦é‡æ–°æ•´ç†é é¢', 'warning');
                });
            
            // å„²å­˜å–æ¶ˆå‡½æ•¸
            realtimeUnsubscribers.push(additionsUnsubscriber);
            
            console.log('âœ… å³æ™‚ç›£è½å·²è¨­å®šå®Œæˆ');
        }

        // ğŸ†• è®Šæ›´å¾Œæ›´æ–°é¡¯ç¤ºï¼ˆå®Œå…¨æœ¬åœ°è¨ˆç®—ç‰ˆï¼‰
        async function updateDisplayAfterChange() {
            try {
                console.log('ğŸ”„ å³æ™‚æ›´æ–°é¡¯ç¤ºä¸­... (å®Œå…¨ä½¿ç”¨æœ¬åœ°è³‡æ–™)');
                
                // ğŸ¯ é‡æ–°è¨ˆç®—çµ±è¨ˆï¼ˆç´”æœ¬åœ°è¨ˆç®—ï¼Œä¸æŸ¥è©¢è³‡æ–™åº«ï¼‰
                updateTenderSummaryLocal();
                
                // ğŸ¯ æ›´æ–°å„å€‹å€å¡Šï¼ˆç´”æœ¬åœ°æ¸²æŸ“ï¼‰
                displayTenderInfo();
                displayOriginalItems();
                displayAdditionItems();
                displaySummaryCards();
                
                console.log('âœ… å³æ™‚æ›´æ–°å®Œæˆ (ç„¡ä»»ä½•è³‡æ–™åº«æŸ¥è©¢)');
                
            } catch (error) {
                console.error('âŒ æ›´æ–°é¡¯ç¤ºå¤±æ•—:', error);
            }
        }

        // ğŸ†• æ¸…ç†å³æ™‚ç›£è½
        function cleanupRealtimeListeners() {
            realtimeUnsubscribers.forEach(unsubscriber => {
                if (typeof unsubscriber === 'function') {
                    unsubscriber();
                }
            });
            realtimeUnsubscribers = [];
            console.log('ğŸ§¹ å³æ™‚ç›£è½å·²æ¸…ç†');
        }

        // ğŸ†• é é¢å¸è¼‰æ™‚æ¸…ç†
        window.addEventListener('beforeunload', cleanupRealtimeListeners);

        // è¼‰å…¥æ¨™å–®è³‡æ–™ï¼ˆåªåœ¨åˆå§‹åŒ–æ™‚åŸ·è¡Œä¸€æ¬¡ï¼‰
        async function loadTenderData(tenderId) {
            try {
                showLoading(true, 'è¼‰å…¥æ¨™å–®è³‡æ–™...');
                
                // è¼‰å…¥æ¨™å–®åŸºæœ¬è³‡æ–™
                const tenderDoc = await db.collection('tenders').doc(tenderId).get();
                if (!tenderDoc.exists) {
                    throw new Error('æ¨™å–®ä¸å­˜åœ¨');
                }
                
                currentTender = { id: tenderId, ...tenderDoc.data() };
                
                // è¼‰å…¥å¤§é …ç›® (ä½¿ç”¨å®‰å…¨æŸ¥è©¢)
                console.log('ğŸ“Š è¼‰å…¥å¤§é …ç›®æ¸…å–®...');
                const majorItemsResult = await safeFirestoreQuery('majorItems', [
                    { field: 'tenderId', operator: '==', value: tenderId },
                    { field: 'createdBy', operator: '==', value: currentUser.email }
                ], {
                    field: 'sequence',
                    direction: 'asc'
                });
                
                const majorItems = majorItemsResult.docs;
                console.log(`âœ… è¼‰å…¥äº† ${majorItems.length} å€‹å¤§é …ç›®`);
                
                majorItems.forEach(item => {
                    majorItemsMap.set(item.id, item);
                });
                
                // è¼‰å…¥æ‰€æœ‰åŸå§‹é …ç›®
                originalItems = [];
                for (const majorItem of majorItems) {
                    const detailItems = await loadDetailItems(majorItem.id);
                    detailItems.forEach(item => {
                        item.majorItemName = majorItem.name;
                        item.majorItemId = majorItem.id;
                        originalItems.push(item);
                    });
                }
                
                // ğŸ¯ åˆæ¬¡è¼‰å…¥è¿½åŠ é …ç›®ï¼ˆä¹‹å¾Œé å³æ™‚ç›£è½ï¼‰
                console.log('ğŸ“Š è¼‰å…¥è¿½åŠ é …ç›®...');
                
                // ä½¿ç”¨æ›´ç°¡å–®çš„æŸ¥è©¢é¿å…ç´¢å¼•å•é¡Œ
                try {
                    const additionResult = await safeFirestoreQuery('additionItems', [
                        { field: 'tenderId', operator: '==', value: tenderId },
                        { field: 'createdBy', operator: '==', value: currentUser.email }
                    ]);
                    
                    additionItems = additionResult.docs;
                    
                    // å®¢æˆ¶ç«¯æ’åº
                    additionItems.sort((a, b) => {
                        const aDate = a.additionDate ? (a.additionDate.toDate ? a.additionDate.toDate() : new Date(a.additionDate)) : new Date(0);
                        const bDate = b.additionDate ? (b.additionDate.toDate ? b.additionDate.toDate() : new Date(b.additionDate)) : new Date(0);
                        return bDate - aDate; // é™åºæ’åˆ—
                    });
                    
                    console.log(`âœ… è¼‰å…¥äº† ${additionItems.length} å€‹è¿½åŠ é …ç›® (å®¢æˆ¶ç«¯æ’åº)`);
                } catch (error) {
                    console.error('âŒ è¼‰å…¥è¿½åŠ é …ç›®å¤±æ•—:', error);
                    additionItems = [];
                    showAlert('è¼‰å…¥è¿½åŠ é …ç›®å¤±æ•—ï¼Œä½†ä¸å½±éŸ¿å…¶ä»–åŠŸèƒ½', 'warning');
                }
                
                // åˆæ¬¡è¼‰å…¥æ™‚çš„çµ±è¨ˆè¨ˆç®—
                updateTenderSummaryInitial();
                
                // é¡¯ç¤ºè³‡æ–™
                displayTenderInfo();
                displayOriginalItems();
                displayAdditionItems();
                displaySummaryCards();
                
                showLoading(false);
                showAlert('æ¨™å–®è³‡æ–™è¼‰å…¥å®Œæˆï¼Œå³æ™‚ç›£è½å·²å•Ÿå‹•', 'success');
                
            } catch (error) {
                console.error('âŒ è¼‰å…¥æ¨™å–®è³‡æ–™å¤±æ•—:', error);
                showAlert('è¼‰å…¥æ¨™å–®è³‡æ–™å¤±æ•—: ' + error.message, 'error');
                showLoading(false);
            }
        }

        // åˆæ¬¡è¼‰å…¥æ™‚çš„çµ±è¨ˆè¨ˆç®—ï¼ˆå¯ä»¥ä½¿ç”¨å¢å¼·ç‰ˆå‡½æ•¸ï¼‰
        function updateTenderSummaryInitial() {
            try {
                // å˜—è©¦ä½¿ç”¨å¢å¼·ç‰ˆçµ±è¨ˆå‡½æ•¸
                if (typeof getTenderSummaryWithAdditions === 'function') {
                    console.log('ğŸ“Š ä½¿ç”¨å¢å¼·ç‰ˆå‡½æ•¸è¨ˆç®—åˆå§‹çµ±è¨ˆ...');
                    getTenderSummaryWithAdditions(currentTender.id).then(summary => {
                        currentTender.summary = summary;
                        console.log('âœ… å¢å¼·ç‰ˆçµ±è¨ˆè¨ˆç®—å®Œæˆ');
                        displayTenderInfo(); // æ›´æ–°é¡¯ç¤º
                    }).catch(error => {
                        console.error('âŒ å¢å¼·ç‰ˆçµ±è¨ˆå¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°è¨ˆç®—:', error);
                        updateTenderSummaryLocal();
                    });
                } else {
                    console.log('âš ï¸ ä½¿ç”¨æœ¬åœ°çµ±è¨ˆè¨ˆç®—æ–¹æ³•');
                    updateTenderSummaryLocal();
                }
            } catch (error) {
                console.error('âŒ è¨ˆç®—åˆå§‹çµ±è¨ˆå¤±æ•—:', error);
                updateTenderSummaryLocal();
            }
        }

        // æœ¬åœ°çµ±è¨ˆè¨ˆç®—ï¼ˆç´”æœ¬åœ°è¨ˆç®—ï¼Œç”¨æ–¼å³æ™‚æ›´æ–°ï¼‰
        function updateTenderSummaryLocal() {
            try {
                console.log('ğŸ“Š è¨ˆç®—æ¨™å–®çµ±è¨ˆ (ä½¿ç”¨æœ¬åœ°è³‡æ–™)...');
                
                // ğŸ¯ å®Œå…¨ä½¿ç”¨æœ¬åœ°è³‡æ–™è¨ˆç®—ï¼Œä¸æŸ¥è©¢è³‡æ–™åº«
                const originalAmount = originalItems.reduce((sum, item) => sum + (item.totalPrice || 0), 0);
                const additionAmount = additionItems.reduce((sum, item) => sum + (item.additionTotalPrice || 0), 0);
                
                currentTender.summary = {
                    originalAmount,
                    additionAmount,
                    totalAmount: originalAmount + additionAmount,
                    percentageIncrease: originalAmount > 0 ? ((additionAmount / originalAmount) * 100) : 0
                };
                
                console.log('âœ… æœ¬åœ°çµ±è¨ˆè¨ˆç®—å®Œæˆ:', {
                    åŸå§‹é‡‘é¡: originalAmount,
                    è¿½åŠ é‡‘é¡: additionAmount,
                    ç¸½é‡‘é¡: currentTender.summary.totalAmount,
                    å¢å¹…: Math.round(currentTender.summary.percentageIncrease) + '%'
                });
                
            } catch (error) {
                console.error('âŒ è¨ˆç®—æœ¬åœ°çµ±è¨ˆå¤±æ•—:', error);
                // è¨­å®šé è¨­å€¼
                currentTender.summary = {
                    originalAmount: 0,
                    additionAmount: 0,
                    totalAmount: 0,
                    percentageIncrease: 0
                };
            }
        }

        // é¡¯ç¤ºæ¨™å–®åŸºæœ¬è³‡è¨Š
        function displayTenderInfo() {
            document.getElementById('tenderName').textContent = currentTender.name || 'æœªå‘½å';
            document.getElementById('contractorName').textContent = currentTender.contractorName || 'æœªæŒ‡å®š';
            
            if (currentTender.summary) {
                const summary = currentTender.summary;
                document.getElementById('originalAmount').textContent = formatCurrency(summary.originalAmount);
                document.getElementById('additionAmount').textContent = formatCurrency(summary.additionAmount);
                document.getElementById('totalAmount').textContent = formatCurrency(summary.totalAmount);
                document.getElementById('increasePercentage').textContent = Math.round(summary.percentageIncrease) + '%';
            }
        }

        // é¡¯ç¤ºåŸå§‹é …ç›®
        function displayOriginalItems() {
            const tbody = document.getElementById('originalItemsTable');
            tbody.innerHTML = '';
            
            originalItems.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'readonly';
                
                // è¨ˆç®—ç›®å‰ç¸½æ•¸é‡ï¼ˆå«è¿½åŠ ï¼‰
                const relatedAdditions = additionItems.filter(add => add.relatedDetailItemId === item.id);
                const additionQty = relatedAdditions.reduce((sum, add) => sum + (add.additionQuantity || 0), 0);
                const currentTotalQty = (item.totalQuantity || item.quantity || 0) + additionQty;
                
                row.innerHTML = `
                    <td>${item.majorItemName}</td>
                    <td>
                        ${item.name}
                        <span class="original-tag">åŸå§‹é …ç›®</span>
                    </td>
                    <td>${item.totalQuantity || item.quantity || 0}</td>
                    <td>${item.unit || ''}</td>
                    <td>${formatCurrency(item.unitPrice || 0)}</td>
                    <td>${formatCurrency(item.totalPrice || 0)}</td>
                    <td><strong>${currentTotalQty}</strong> ${additionQty > 0 ? `(+${additionQty})` : ''}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="addQuantityToItem('${item.id}', '${item.name}')">
                            â• è¿½åŠ æ•¸é‡
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // é¡¯ç¤ºè¿½åŠ é …ç›®
        function displayAdditionItems() {
            const tbody = document.getElementById('additionItemsTable');
            const noMessage = document.getElementById('noAdditionsMessage');
            
            tbody.innerHTML = '';
            
            if (additionItems.length === 0) {
                noMessage.style.display = 'block';
                return;
            }
            
            noMessage.style.display = 'none';
            
            additionItems.forEach(item => {
                const row = document.createElement('tr');
                
                // æ‰¾åˆ°é—œè¯çš„åŸå§‹é …ç›®
                const relatedItem = originalItems.find(orig => orig.id === item.relatedDetailItemId);
                const relatedItemName = relatedItem ? relatedItem.name : 'å·²åˆªé™¤é …ç›®';
                
                row.innerHTML = `
                    <td>${formatDate(item.additionDate)}</td>
                    <td>
                        ${relatedItemName}
                        <span class="addition-tag">è¿½åŠ é …ç›®</span>
                    </td>
                    <td>${item.additionQuantity || 0} ${item.unit || ''}</td>
                    <td>${formatCurrency(item.additionUnitPrice || 0)}</td>
                    <td>${formatCurrency(item.additionTotalPrice || 0)}</td>
                    <td>${item.additionReason || ''}</td>
                    <td>
                        <span style="color: ${item.additionApproved ? '#28a745' : '#ffc107'};">
                            ${item.additionApproved ? 'âœ… å·²æ ¸å‡†' : 'â³ å¾…æ ¸å‡†'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editAdditionItem('${item.id}')">
                            ç·¨è¼¯
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteAdditionItemConfirm('${item.id}')">
                            åˆªé™¤
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // é¡¯ç¤ºçµ±è¨ˆå¡ç‰‡
        function displaySummaryCards() {
            const grid = document.getElementById('summaryGrid');
            grid.innerHTML = '';
            
            // æŒ‰é …ç›®åˆ†çµ„çµ±è¨ˆ
            const itemGroups = new Map();
            
            // å…ˆå»ºç«‹æ‰€æœ‰åŸå§‹é …ç›®çš„åŸºç¤è³‡æ–™
            originalItems.forEach(item => {
                const key = item.name;
                if (!itemGroups.has(key)) {
                    itemGroups.set(key, {
                        name: key,
                        unit: item.unit || '',
                        originalQuantity: 0,
                        additionQuantity: 0,
                        originalAmount: 0,
                        additionAmount: 0,
                        hasAdditions: false
                    });
                }
                
                const group = itemGroups.get(key);
                group.originalQuantity += item.totalQuantity || item.quantity || 0;
                group.originalAmount += item.totalPrice || 0;
            });
            
            // è¨ˆç®—è¿½åŠ é …ç›®çš„çµ±è¨ˆ
            additionItems.forEach(item => {
                const relatedItem = originalItems.find(orig => orig.id === item.relatedDetailItemId);
                if (relatedItem) {
                    const key = relatedItem.name;
                    if (itemGroups.has(key)) {
                        const group = itemGroups.get(key);
                        group.additionQuantity += item.additionQuantity || 0;
                        group.additionAmount += item.additionTotalPrice || 0;
                        group.hasAdditions = true; // æ¨™è¨˜ç‚ºæœ‰è¿½åŠ 
                    }
                }
            });
            
            // ğŸ¯ åªé¡¯ç¤ºæœ‰è¿½åŠ é …ç›®çš„çµ±è¨ˆå¡ç‰‡
            const itemsWithAdditions = Array.from(itemGroups.values()).filter(group => group.hasAdditions);
            
            if (itemsWithAdditions.length === 0) {
                // å¦‚æœæ²’æœ‰ä»»ä½•è¿½åŠ é …ç›®ï¼Œé¡¯ç¤ºæç¤ºè¨Šæ¯
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #6c757d;">
                        <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“Š</div>
                        <div style="font-size: 18px; margin-bottom: 10px;">ç›®å‰æ²’æœ‰è¿½åŠ é …ç›®</div>
                        <small>æ–°å¢è¿½åŠ é …ç›®å¾Œï¼Œé€™è£¡æœƒé¡¯ç¤ºæ•¸é‡å°æ¯”çµ±è¨ˆ</small>
                    </div>
                `;
                return;
            }
            
            // ç”Ÿæˆæœ‰è¿½åŠ é …ç›®çš„çµ±è¨ˆå¡ç‰‡
            itemsWithAdditions.forEach(group => {
                const card = document.createElement('div');
                card.className = 'summary-card';
                
                const totalQuantity = group.originalQuantity + group.additionQuantity;
                const totalAmount = group.originalAmount + group.additionAmount;
                const increasePercentage = group.originalQuantity > 0 ? 
                    Math.round((group.additionQuantity / group.originalQuantity) * 100) : 0;
                
                card.innerHTML = `
                    <div class="summary-item-name">
                        ${group.name}
                        <span style="color: #ffc107; font-size: 12px; margin-left: 8px;">
                            +${increasePercentage}%
                        </span>
                    </div>
                    <div class="summary-detail">
                        <span>åŸå§‹æ•¸é‡:</span>
                        <span>${group.originalQuantity} ${group.unit}</span>
                    </div>
                    <div class="summary-detail">
                        <span>è¿½åŠ æ•¸é‡:</span>
                        <span style="color: #ffc107; font-weight: 600;">+${group.additionQuantity} ${group.unit}</span>
                    </div>
                    <div class="summary-detail">
                        <span><strong>ç¸½è¨ˆæ•¸é‡:</strong></span>
                        <span><strong style="color: #667eea;">${totalQuantity} ${group.unit}</strong></span>
                    </div>
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e9ecef; font-size: 12px; color: #666;">
                        é‡‘é¡å¢åŠ : ${formatCurrency(group.additionAmount)}
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }

        // è¨­å®šäº‹ä»¶ç›£è½å™¨
        function setupEventListeners() {
            // è¿½åŠ é …ç›®è¡¨å–®æäº¤
            document.getElementById('additionForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await submitAdditionForm();
            });
            
            // è¨­å®šä»Šå¤©çš„æ—¥æœŸç‚ºé è¨­å€¼
            document.getElementById('additionDate').value = new Date().toISOString().split('T')[0];
            
            // ç›£è½é—œè¯é …ç›®è®Šæ›´
            document.getElementById('relatedDetailItem').addEventListener('change', onRelatedItemChange);
        }

        // é¡¯ç¤ºè¿½åŠ  Modal
        function showAdditionModal(preSelectedItemId = null) {
            const modal = document.getElementById('additionModal');
            const select = document.getElementById('relatedDetailItem');
            
            // å¡«å……åŸå§‹é …ç›®é¸é …
            select.innerHTML = '<option value="">è«‹é¸æ“‡è¦è¿½åŠ çš„åŸå§‹é …ç›®</option>';
            originalItems.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `${item.majorItemName} - ${item.name} (ç›®å‰: ${item.totalQuantity || item.quantity || 0} ${item.unit || ''})`;
                select.appendChild(option);
            });
            
            // å¦‚æœæœ‰é é¸é …ç›®
            if (preSelectedItemId) {
                select.value = preSelectedItemId;
                onRelatedItemChange(); // è‡ªå‹•å¡«å…¥å–®åƒ¹
            }
            
            // é‡è¨­è¡¨å–®ç‹€æ…‹
            const submitBtn = document.querySelector('#additionForm button[type="submit"]');
            submitBtn.innerHTML = 'â• æ–°å¢è¿½åŠ é …ç›®';
            submitBtn.onclick = null;
            
            modal.style.display = 'block';
        }

        // é—œé–‰è¿½åŠ  Modal
        function closeAdditionModal() {
            document.getElementById('additionModal').style.display = 'none';
            document.getElementById('additionForm').reset();
        }

        // ç•¶é¸æ“‡é—œè¯é …ç›®æ™‚ï¼Œè‡ªå‹•å¡«å…¥å»ºè­°å–®åƒ¹
        function onRelatedItemChange() {
            const select = document.getElementById('relatedDetailItem');
            const unitPriceInput = document.getElementById('additionUnitPrice');
            
            if (select.value) {
                const selectedItem = originalItems.find(item => item.id === select.value);
                if (selectedItem) {
                    unitPriceInput.value = selectedItem.unitPrice || 0;
                }
            }
        }

        // ğŸš€ æäº¤è¿½åŠ é …ç›®è¡¨å–®ï¼ˆå¼·åŒ–ç‰ˆ - åŒ…å«æ‰‹å‹•æ›´æ–°ï¼‰
        async function submitAdditionForm() {
            try {
                showLoading(true, 'æ–°å¢è¿½åŠ é …ç›®...');
                
                const formData = {
                    relatedDetailItemId: document.getElementById('relatedDetailItem').value,
                    tenderId: currentTender.id,
                    additionQuantity: parseInt(document.getElementById('additionQuantity').value),
                    additionUnitPrice: parseFloat(document.getElementById('additionUnitPrice').value),
                    additionReason: document.getElementById('additionReason').value.trim(),
                    additionDate: document.getElementById('additionDate').value ? 
                        new Date(document.getElementById('additionDate').value + 'T00:00:00') : 
                        new Date(),
                    approvedBy: document.getElementById('approvedBy').value.trim(),
                    notes: document.getElementById('additionNotes').value.trim(),
                    additionApproved: false // é è¨­ç‚ºå¾…æ ¸å‡†
                };
                
                // æ‰¾åˆ°é—œè¯é …ç›®çš„è³‡è¨Š
                const relatedItem = originalItems.find(item => item.id === formData.relatedDetailItemId);
                if (relatedItem) {
                    formData.majorItemId = relatedItem.majorItemId;
                    formData.name = relatedItem.name;
                    formData.unit = relatedItem.unit;
                }
                
                let newItemData = null;
                
                // ğŸ¯ é—œéµæ“ä½œï¼šå¢é‡æ›´æ–°
                if (typeof createAdditionItem === 'function') {
                    // ä½¿ç”¨å¢å¼·ç‰ˆå‡½æ•¸ï¼ˆæœƒè‡ªå‹•è§¸ç™¼å³æ™‚ç›£è½ï¼‰
                    const additionId = await createAdditionItem(formData);
                    console.log('âœ… ä½¿ç”¨å¢å¼·ç‰ˆå‡½æ•¸æ–°å¢è¿½åŠ é …ç›®:', additionId);
                    
                    // æ‰‹å‹•å»ºç«‹æ–°é …ç›®è³‡æ–™ä»¥å‚™ç”¨
                    newItemData = {
                        id: additionId,
                        ...formData,
                        additionTotalPrice: formData.additionQuantity * formData.additionUnitPrice,
                        createdBy: currentUser.email,
                        createdAt: new Date()
                    };
                } else {
                    // ç›´æ¥ä½¿ç”¨ Firestore æ–°å¢ï¼ˆæœƒè§¸ç™¼å³æ™‚ç›£è½ï¼‰
                    console.log('âš ï¸ ä½¿ç”¨ç›´æ¥ Firestore æ–°å¢æ–¹æ³•');
                    const additionData = {
                        ...formData,
                        additionTotalPrice: formData.additionQuantity * formData.additionUnitPrice,
                        createdBy: currentUser.email,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    const docRef = await db.collection('additionItems').add(additionData);
                    
                    // æ‰‹å‹•å»ºç«‹æ–°é …ç›®è³‡æ–™ä»¥å‚™ç”¨
                    newItemData = {
                        id: docRef.id,
                        ...formData,
                        additionTotalPrice: formData.additionQuantity * formData.additionUnitPrice,
                        createdBy: currentUser.email,
                        createdAt: new Date()
                    };
                }
                
                // ğŸš€ å‚™ç”¨æ©Ÿåˆ¶ï¼šå¦‚æœå³æ™‚ç›£è½æ²’è§¸ç™¼ï¼Œæ‰‹å‹•æ›´æ–°
                setTimeout(() => {
                    if (newItemData && !additionItems.find(item => item.id === newItemData.id)) {
                        console.log('âš ï¸ å³æ™‚ç›£è½æœªè§¸ç™¼ï¼Œæ‰‹å‹•æ–°å¢é …ç›®åˆ°æœ¬åœ°é™£åˆ—');
                        additionItems.unshift(newItemData);
                        updateDisplayAfterChange();
                    }
                }, 1000); // 1ç§’å¾Œæª¢æŸ¥
                
                closeAdditionModal();
                showLoading(false);
                showAlert('è¿½åŠ é …ç›®æ–°å¢æˆåŠŸï¼', 'success');
                
            } catch (error) {
                console.error('âŒ æ–°å¢è¿½åŠ é …ç›®å¤±æ•—:', error);
                showAlert('æ–°å¢è¿½åŠ é …ç›®å¤±æ•—: ' + error.message, 'error');
                showLoading(false);
            }
        }

        // å¿«é€Ÿè¿½åŠ æ•¸é‡åˆ°æŒ‡å®šé …ç›®
        function addQuantityToItem(itemId, itemName) {
            showAdditionModal(itemId);
            
            // è¨­å®šé è¨­è¿½åŠ åŸå› 
            setTimeout(() => {
                document.getElementById('additionReason').value = `${itemName} æ•¸é‡è¿½åŠ `;
                document.getElementById('additionQuantity').focus();
            }, 100);
        }

        // ç·¨è¼¯è¿½åŠ é …ç›®
        function editAdditionItem(additionId) {
            const addition = additionItems.find(item => item.id === additionId);
            if (!addition) {
                showAlert('æ‰¾ä¸åˆ°è¿½åŠ é …ç›®', 'error');
                return;
            }
            
            // å¡«å…¥ç¾æœ‰è³‡æ–™åˆ°è¡¨å–®
            showAdditionModal(addition.relatedDetailItemId);
            
            setTimeout(() => {
                document.getElementById('additionQuantity').value = addition.additionQuantity || '';
                document.getElementById('additionUnitPrice').value = addition.additionUnitPrice || '';
                document.getElementById('additionReason').value = addition.additionReason || '';
                document.getElementById('approvedBy').value = addition.approvedBy || '';
                document.getElementById('additionNotes').value = addition.notes || '';
                
                if (addition.additionDate) {
                    const date = addition.additionDate.toDate ? addition.additionDate.toDate() : new Date(addition.additionDate);
                    document.getElementById('additionDate').value = date.toISOString().split('T')[0];
                }
                
                // ä¿®æ”¹æäº¤æŒ‰éˆ•
                const submitBtn = document.querySelector('#additionForm button[type="submit"]');
                submitBtn.innerHTML = 'ğŸ’¾ æ›´æ–°è¿½åŠ é …ç›®';
                submitBtn.onclick = (e) => {
                    e.preventDefault();
                    updateAdditionItemAction(additionId);
                };
            }, 100);
        }

        // ğŸš€ æ›´æ–°è¿½åŠ é …ç›®ï¼ˆå„ªåŒ–ç‰ˆï¼‰
        async function updateAdditionItemAction(additionId) {
            try {
                showLoading(true, 'æ›´æ–°è¿½åŠ é …ç›®...');
                
                const updateData = {
                    additionQuantity: parseInt(document.getElementById('additionQuantity').value),
                    additionUnitPrice: parseFloat(document.getElementById('additionUnitPrice').value),
                    additionReason: document.getElementById('additionReason').value.trim(),
                    additionDate: document.getElementById('additionDate').value ? 
                        new Date(document.getElementById('additionDate').value + 'T00:00:00') : 
                        new Date(),
                    approvedBy: document.getElementById('approvedBy').value.trim(),
                    notes: document.getElementById('additionNotes').value.trim()
                };
                
                // ğŸ¯ é—œéµæ“ä½œï¼šå¢é‡æ›´æ–°
                if (typeof updateAdditionItem === 'function') {
                    // ä½¿ç”¨å¢å¼·ç‰ˆå‡½æ•¸
                    await updateAdditionItem(additionId, updateData);
                    console.log('âœ… ä½¿ç”¨å¢å¼·ç‰ˆå‡½æ•¸æ›´æ–°è¿½åŠ é …ç›®');
                } else {
                    // ç›´æ¥ä½¿ç”¨ Firestore æ›´æ–°
                    console.log('âš ï¸ ä½¿ç”¨ç›´æ¥ Firestore æ›´æ–°æ–¹æ³•');
                    updateData.additionTotalPrice = updateData.additionQuantity * updateData.additionUnitPrice;
                    updateData.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                    
                    await db.collection('additionItems').doc(additionId).update(updateData);
                }
                
                // ğŸ¯ ä¸éœ€è¦é‡æ–°è¼‰å…¥ï¼Œå³æ™‚ç›£è½æœƒè‡ªå‹•æ›´æ–°ï¼
                closeAdditionModal();
                showLoading(false);
                showAlert('è¿½åŠ é …ç›®æ›´æ–°æˆåŠŸï¼å³æ™‚åŒæ­¥ä¸­...', 'success');
                
            } catch (error) {
                console.error('âŒ æ›´æ–°è¿½åŠ é …ç›®å¤±æ•—:', error);
                showAlert('æ›´æ–°è¿½åŠ é …ç›®å¤±æ•—: ' + error.message, 'error');
                showLoading(false);
            }
        }

        // ç¢ºèªåˆªé™¤è¿½åŠ é …ç›®
        function deleteAdditionItemConfirm(additionId) {
            const addition = additionItems.find(item => item.id === additionId);
            if (!addition) {
                showAlert('æ‰¾ä¸åˆ°è¿½åŠ é …ç›®', 'error');
                return;
            }
            
            const relatedItem = originalItems.find(orig => orig.id === addition.relatedDetailItemId);
            const itemName = relatedItem ? relatedItem.name : 'æœªçŸ¥é …ç›®';
            
            if (confirm(`ç¢ºå®šè¦åˆªé™¤é€™å€‹è¿½åŠ é …ç›®å—ï¼Ÿ\n\né …ç›®ï¼š${itemName}\næ•¸é‡ï¼š${addition.additionQuantity} ${addition.unit || ''}\né‡‘é¡ï¼š${formatCurrency(addition.additionTotalPrice)}\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) {
                deleteAdditionItemAction(additionId);
            }
        }

        // ğŸš€ åŸ·è¡Œåˆªé™¤è¿½åŠ é …ç›®ï¼ˆå„ªåŒ–ç‰ˆï¼‰
        async function deleteAdditionItemAction(additionId) {
            try {
                showLoading(true, 'åˆªé™¤è¿½åŠ é …ç›®...');
                
                // ğŸ¯ é—œéµæ“ä½œï¼šå¢é‡æ›´æ–°
                if (typeof deleteAdditionItem === 'function') {
                    // ä½¿ç”¨å¢å¼·ç‰ˆå‡½æ•¸
                    await deleteAdditionItem(additionId);
                    console.log('âœ… ä½¿ç”¨å¢å¼·ç‰ˆå‡½æ•¸åˆªé™¤è¿½åŠ é …ç›®');
                } else {
                    // ç›´æ¥ä½¿ç”¨ Firestore åˆªé™¤
                    console.log('âš ï¸ ä½¿ç”¨ç›´æ¥ Firestore åˆªé™¤æ–¹æ³•');
                    await db.collection('additionItems').doc(additionId).delete();
                }
                
                // ğŸ¯ ä¸éœ€è¦é‡æ–°è¼‰å…¥ï¼Œå³æ™‚ç›£è½æœƒè‡ªå‹•æ›´æ–°ï¼
                showLoading(false);
                showAlert('è¿½åŠ é …ç›®å·²åˆªé™¤ï¼å³æ™‚åŒæ­¥ä¸­...', 'success');
                
            } catch (error) {
                console.error('âŒ åˆªé™¤è¿½åŠ é …ç›®å¤±æ•—:', error);
                showAlert('åˆªé™¤è¿½åŠ é …ç›®å¤±æ•—: ' + error.message, 'error');
                showLoading(false);
            }
        }

        // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
        function showLoading(show, text = 'è¼‰å…¥ä¸­...') {
            const loadingSection = document.getElementById('loadingSection');
            const loadingText = document.getElementById('loadingText');
            
            if (show) {
                loadingSection.style.display = 'block';
                loadingText.textContent = text;
            } else {
                loadingSection.style.display = 'none';
            }
        }

        // é¡¯ç¤ºæç¤ºè¨Šæ¯
        function showAlert(message, type = 'info') {
            const alertMessage = document.getElementById('alertMessage');
            alertMessage.textContent = message;
            alertMessage.className = 'alert ' + type;
            alertMessage.style.display = 'block';
            
            setTimeout(() => {
                alertMessage.style.display = 'none';
            }, 5000);
        }

        // å°èˆªåŠŸèƒ½
        function goToDashboard() {
            window.location.href = '../dashboard.html';
        }

        // ç™»å‡ºåŠŸèƒ½
        async function logout() {
            if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                try {
                    await auth.signOut();
                    window.location.href = '../login_page.html';
                } catch (error) {
                    console.error('ç™»å‡ºå¤±æ•—:', error);
                    showAlert('ç™»å‡ºå¤±æ•—ï¼Œè«‹é‡è©¦', 'error');
                }
            }
        }

        // é»æ“Š Modal å¤–éƒ¨é—œé–‰
        window.onclick = function(event) {
            const modal = document.getElementById('additionModal');
            if (event.target === modal) {
                closeAdditionModal();
            }
        }
    </script>
</body>
</html>