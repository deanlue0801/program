<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>標單編輯 - 專案管理系統</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: #666;
        }

        .breadcrumb a {
            color: #667eea;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-logout { background: #ff6b6b; color: white; }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .content-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .page-title {
            font-size: 2rem;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .page-subtitle {
            color: #666;
            margin-bottom: 30px;
        }

        /* 標單資訊卡片 */
        .tender-info-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            border-left: 4px solid #667eea;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .info-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .info-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .info-value.amount {
            color: #28a745;
        }

        .info-value.addition {
            color: #ffc107;
        }

        .info-value.total {
            color: #667eea;
            font-size: 20px;
        }

        /* 項目表格樣式 */
        .items-section {
            margin-bottom: 40px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .section-title {
            font-size: 1.4rem;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .items-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .items-table th,
        .items-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .items-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        .items-table td {
            font-size: 14px;
            vertical-align: middle;
        }

        .items-table tr:hover {
            background: #f8f9fa;
        }

        .items-table tr.readonly {
            background: #f1f3f4;
            color: #6c757d;
        }

        .original-tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .addition-tag {
            background: #fff3e0;
            color: #f57c00;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        /* 統計卡片 */
        .summary-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .summary-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #667eea;
        }

        .summary-item-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        .summary-detail {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .summary-detail:last-child {
            margin-bottom: 0;
            padding-top: 8px;
            border-top: 1px solid #e9ecef;
            font-weight: 600;
        }

        /* 追加項目 Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .modal-title {
            font-size: 1.4rem;
            color: #333;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #000;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #495057;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .alert.warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .navbar {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <nav class="navbar">
            <div class="breadcrumb">
                <a href="javascript:void(0)" onclick="goToDashboard()">首頁</a>
                <span>/</span>
                <a href="list.html">標單管理</a>
                <span>/</span>
                <span>標單編輯</span>
            </div>
            <div class="user-info">
                <span id="currentUser">載入中...</span>
                <button class="btn btn-logout" onclick="logout()">登出</button>
            </div>
        </nav>

        <div class="content-card">
            <h1 class="page-title">📋 標單編輯</h1>
            <p class="page-subtitle">管理原始項目與追加項目，保持完整的變更歷史記錄</p>

            <!-- 標單基本資訊 -->
            <div class="tender-info-section">
                <h3>📊 標單資訊</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">標單名稱</div>
                        <div class="info-value" id="tenderName">載入中...</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">承包商</div>
                        <div class="info-value" id="contractorName">載入中...</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">原始合約金額</div>
                        <div class="info-value amount" id="originalAmount">NT$ 0</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">追加金額</div>
                        <div class="info-value addition" id="additionAmount">NT$ 0</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">目前總金額</div>
                        <div class="info-value total" id="totalAmount">NT$ 0</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">增幅百分比</div>
                        <div class="info-value" id="increasePercentage">0%</div>
                    </div>
                </div>
            </div>

            <!-- 原始項目清單 -->
            <div class="items-section">
                <div class="section-header">
                    <h3 class="section-title">📋 原始項目 (不可修改)</h3>
                    <div class="info-label">簽約時的原始項目，保持合約完整性</div>
                </div>
                
                <table class="items-table">
                    <thead>
                        <tr>
                            <th>大項目</th>
                            <th>項目名稱</th>
                            <th>原始數量</th>
                            <th>單位</th>
                            <th>原始單價</th>
                            <th>原始小計</th>
                            <th>目前總數量</th>
                            <th>追加操作</th>
                        </tr>
                    </thead>
                    <tbody id="originalItemsTable">
                        <!-- 動態載入原始項目 -->
                    </tbody>
                </table>
            </div>

            <!-- 追加項目清單 -->
            <div class="items-section">
                <div class="section-header">
                    <h3 class="section-title">➕ 追加項目</h3>
                    <button class="btn btn-success" onclick="showAdditionModal()">
                        ➕ 新增追加項目
                    </button>
                </div>
                
                <table class="items-table">
                    <thead>
                        <tr>
                            <th>追加日期</th>
                            <th>關聯項目</th>
                            <th>追加數量</th>
                            <th>追加單價</th>
                            <th>追加金額</th>
                            <th>追加原因</th>
                            <th>狀態</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="additionItemsTable">
                        <!-- 動態載入追加項目 -->
                    </tbody>
                </table>
                
                <div id="noAdditionsMessage" style="text-align: center; padding: 40px; color: #6c757d; display: none;">
                    <div style="font-size: 48px; margin-bottom: 15px;">📝</div>
                    <div>目前沒有追加項目</div>
                    <small>點擊上方「新增追加項目」按鈕開始添加</small>
                </div>
            </div>

            <!-- 總覽統計 -->
            <div class="summary-section">
                <h3>📊 數量統計總覽</h3>
                <div class="summary-grid" id="summaryGrid">
                    <!-- 動態載入統計卡片 -->
                </div>
            </div>

            <!-- 載入動畫 -->
            <div id="loadingSection" class="loading">
                <div class="spinner"></div>
                <p id="loadingText">載入中...</p>
            </div>

            <!-- 提示訊息 -->
            <div id="alertMessage" class="alert"></div>
        </div>
    </div>

    <!-- 追加項目 Modal -->
    <div id="additionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">➕ 新增追加項目</h3>
                <span class="close" onclick="closeAdditionModal()">&times;</span>
            </div>
            
            <form id="additionForm">
                <div class="form-group">
                    <label for="relatedDetailItem">選擇關聯項目 <span style="color: #dc3545;">*</span></label>
                    <select id="relatedDetailItem" class="form-control" required>
                        <option value="">請選擇要追加的原始項目</option>
                    </select>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="additionQuantity">追加數量 <span style="color: #dc3545;">*</span></label>
                        <input type="number" id="additionQuantity" class="form-control" min="1" required>
                    </div>
                    <div class="form-group">
                        <label for="additionUnitPrice">追加單價 <span style="color: #dc3545;">*</span></label>
                        <input type="number" id="additionUnitPrice" class="form-control" min="0" step="0.01" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="additionReason">追加原因 <span style="color: #dc3545;">*</span></label>
                    <textarea id="additionReason" class="form-control" rows="3" placeholder="請詳細說明追加的原因..." required></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="additionDate">追加日期</label>
                        <input type="date" id="additionDate" class="form-control" value="">
                    </div>
                    <div class="form-group">
                        <label for="approvedBy">核准人員</label>
                        <input type="text" id="approvedBy" class="form-control" placeholder="可選填">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="additionNotes">備註</label>
                    <textarea id="additionNotes" class="form-control" rows="2" placeholder="其他備註說明..."></textarea>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button type="button" class="btn btn-secondary" onclick="closeAdditionModal()">
                        取消
                    </button>
                    <button type="submit" class="btn btn-success">
                        ➕ 新增追加項目
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <!-- 最終增強版統一配置檔 -->
    <script src="../assets/js/firebase-config.js"></script>

    <script>
        // 全域變數
        let currentTender = null;
        let originalItems = [];
        let additionItems = [];
        let majorItemsMap = new Map();
        let realtimeUnsubscribers = []; // 儲存即時監聽的取消函數

        // 獲取 URL 參數
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // 初始化應用
        document.addEventListener('DOMContentLoaded', function() {
            initFirebase(async function(user) {
                console.log('✅ 標單編輯功能初始化成功，用戶:', user.email);
                
                const tenderId = getUrlParameter('id');
                if (!tenderId) {
                    showAlert('缺少標單ID參數', 'error');
                    setTimeout(() => {
                        window.location.href = 'list.html';
                    }, 2000);
                    return;
                }
                
                // 載入標單資料
                await loadTenderData(tenderId);
                
                // 🚀 設定即時監聽
                setupRealtimeListeners(tenderId);
                
                // 設定事件監聽器
                setupEventListeners();
            });
        });

        // 🆕 設定即時監聽（修正版）
        function setupRealtimeListeners(tenderId) {
            console.log('🔄 設定即時監聽... tenderId:', tenderId);
            
            // 1. 監聽追加項目變更（簡化查詢避免索引問題）
            const additionsUnsubscriber = db.collection('additionItems')
                .where('tenderId', '==', tenderId)
                .where('createdBy', '==', currentUser.email)
                .onSnapshot((snapshot) => {
                    console.log('📡 追加項目即時更新 - 變更數量:', snapshot.docChanges().length);
                    console.log('📡 當前快照大小:', snapshot.size);
                    
                    let hasChanges = false;
                    
                    snapshot.docChanges().forEach((change) => {
                        const itemData = { id: change.doc.id, ...change.doc.data() };
                        console.log('📡 變更類型:', change.type, '項目:', itemData.name);
                        
                        if (change.type === "added") {
                            // 檢查是否已存在（避免重複）
                            const existingIndex = additionItems.findIndex(item => item.id === itemData.id);
                            if (existingIndex === -1) {
                                additionItems.unshift(itemData); // 新增到頭部
                                console.log('➕ 追加項目已新增:', itemData.name, itemData.additionQuantity);
                                hasChanges = true;
                            } else {
                                console.log('⚪ 項目已存在，跳過:', itemData.name);
                            }
                        }
                        
                        if (change.type === "modified") {
                            const index = additionItems.findIndex(item => item.id === itemData.id);
                            if (index !== -1) {
                                additionItems[index] = itemData;
                                console.log('📝 追加項目已修改:', itemData.name, itemData.additionQuantity);
                                hasChanges = true;
                            } else {
                                // 如果本地沒有，當作新增處理
                                additionItems.unshift(itemData);
                                console.log('➕ 修改時發現新項目，已新增:', itemData.name);
                                hasChanges = true;
                            }
                        }
                        
                        if (change.type === "removed") {
                            const originalLength = additionItems.length;
                            additionItems = additionItems.filter(item => item.id !== itemData.id);
                            if (additionItems.length < originalLength) {
                                console.log('🗑️ 追加項目已刪除:', itemData.name);
                                hasChanges = true;
                            }
                        }
                    });
                    
                    // 強制更新顯示（無論是否有變更）
                    if (hasChanges || snapshot.docChanges().length > 0) {
                        console.log('🔄 觸發即時更新顯示 (有變更:', hasChanges, ')');
                        updateDisplayAfterChange();
                    } else {
                        console.log('⚪ 無變更，跳過更新');
                    }
                }, (error) => {
                    console.error('❌ 追加項目即時監聽錯誤:', error);
                    console.error('❌ 錯誤詳情:', error.message);
                    // 如果即時監聽失敗，顯示警告但不中斷
                    showAlert('即時監聽可能中斷，部分更新需要重新整理頁面', 'warning');
                });
            
            // 儲存取消函數
            realtimeUnsubscribers.push(additionsUnsubscriber);
            
            console.log('✅ 即時監聽已設定完成');
        }

        // 🆕 變更後更新顯示（完全本地計算版）
        async function updateDisplayAfterChange() {
            try {
                console.log('🔄 即時更新顯示中... (完全使用本地資料)');
                
                // 🎯 重新計算統計（純本地計算，不查詢資料庫）
                updateTenderSummaryLocal();
                
                // 🎯 更新各個區塊（純本地渲染）
                displayTenderInfo();
                displayOriginalItems();
                displayAdditionItems();
                displaySummaryCards();
                
                console.log('✅ 即時更新完成 (無任何資料庫查詢)');
                
            } catch (error) {
                console.error('❌ 更新顯示失敗:', error);
            }
        }

        // 🆕 清理即時監聽
        function cleanupRealtimeListeners() {
            realtimeUnsubscribers.forEach(unsubscriber => {
                if (typeof unsubscriber === 'function') {
                    unsubscriber();
                }
            });
            realtimeUnsubscribers = [];
            console.log('🧹 即時監聽已清理');
        }

        // 🆕 頁面卸載時清理
        window.addEventListener('beforeunload', cleanupRealtimeListeners);

        // 載入標單資料（只在初始化時執行一次）
        async function loadTenderData(tenderId) {
            try {
                showLoading(true, '載入標單資料...');
                
                // 載入標單基本資料
                const tenderDoc = await db.collection('tenders').doc(tenderId).get();
                if (!tenderDoc.exists) {
                    throw new Error('標單不存在');
                }
                
                currentTender = { id: tenderId, ...tenderDoc.data() };
                
                // 載入大項目 (使用安全查詢)
                console.log('📊 載入大項目清單...');
                const majorItemsResult = await safeFirestoreQuery('majorItems', [
                    { field: 'tenderId', operator: '==', value: tenderId },
                    { field: 'createdBy', operator: '==', value: currentUser.email }
                ], {
                    field: 'sequence',
                    direction: 'asc'
                });
                
                const majorItems = majorItemsResult.docs;
                console.log(`✅ 載入了 ${majorItems.length} 個大項目`);
                
                majorItems.forEach(item => {
                    majorItemsMap.set(item.id, item);
                });
                
                // 載入所有原始項目
                originalItems = [];
                for (const majorItem of majorItems) {
                    const detailItems = await loadDetailItems(majorItem.id);
                    detailItems.forEach(item => {
                        item.majorItemName = majorItem.name;
                        item.majorItemId = majorItem.id;
                        originalItems.push(item);
                    });
                }
                
                // 🎯 初次載入追加項目（之後靠即時監聽）
                console.log('📊 載入追加項目...');
                
                // 使用更簡單的查詢避免索引問題
                try {
                    const additionResult = await safeFirestoreQuery('additionItems', [
                        { field: 'tenderId', operator: '==', value: tenderId },
                        { field: 'createdBy', operator: '==', value: currentUser.email }
                    ]);
                    
                    additionItems = additionResult.docs;
                    
                    // 客戶端排序
                    additionItems.sort((a, b) => {
                        const aDate = a.additionDate ? (a.additionDate.toDate ? a.additionDate.toDate() : new Date(a.additionDate)) : new Date(0);
                        const bDate = b.additionDate ? (b.additionDate.toDate ? b.additionDate.toDate() : new Date(b.additionDate)) : new Date(0);
                        return bDate - aDate; // 降序排列
                    });
                    
                    console.log(`✅ 載入了 ${additionItems.length} 個追加項目 (客戶端排序)`);
                } catch (error) {
                    console.error('❌ 載入追加項目失敗:', error);
                    additionItems = [];
                    showAlert('載入追加項目失敗，但不影響其他功能', 'warning');
                }
                
                // 初次載入時的統計計算
                updateTenderSummaryInitial();
                
                // 顯示資料
                displayTenderInfo();
                displayOriginalItems();
                displayAdditionItems();
                displaySummaryCards();
                
                showLoading(false);
                showAlert('標單資料載入完成，即時監聽已啟動', 'success');
                
            } catch (error) {
                console.error('❌ 載入標單資料失敗:', error);
                showAlert('載入標單資料失敗: ' + error.message, 'error');
                showLoading(false);
            }
        }

        // 初次載入時的統計計算（可以使用增強版函數）
        function updateTenderSummaryInitial() {
            try {
                // 嘗試使用增強版統計函數
                if (typeof getTenderSummaryWithAdditions === 'function') {
                    console.log('📊 使用增強版函數計算初始統計...');
                    getTenderSummaryWithAdditions(currentTender.id).then(summary => {
                        currentTender.summary = summary;
                        console.log('✅ 增強版統計計算完成');
                        displayTenderInfo(); // 更新顯示
                    }).catch(error => {
                        console.error('❌ 增強版統計失敗，使用本地計算:', error);
                        updateTenderSummaryLocal();
                    });
                } else {
                    console.log('⚠️ 使用本地統計計算方法');
                    updateTenderSummaryLocal();
                }
            } catch (error) {
                console.error('❌ 計算初始統計失敗:', error);
                updateTenderSummaryLocal();
            }
        }

        // 本地統計計算（純本地計算，用於即時更新）
        function updateTenderSummaryLocal() {
            try {
                console.log('📊 計算標單統計 (使用本地資料)...');
                
                // 🎯 完全使用本地資料計算，不查詢資料庫
                const originalAmount = originalItems.reduce((sum, item) => sum + (item.totalPrice || 0), 0);
                const additionAmount = additionItems.reduce((sum, item) => sum + (item.additionTotalPrice || 0), 0);
                
                currentTender.summary = {
                    originalAmount,
                    additionAmount,
                    totalAmount: originalAmount + additionAmount,
                    percentageIncrease: originalAmount > 0 ? ((additionAmount / originalAmount) * 100) : 0
                };
                
                console.log('✅ 本地統計計算完成:', {
                    原始金額: originalAmount,
                    追加金額: additionAmount,
                    總金額: currentTender.summary.totalAmount,
                    增幅: Math.round(currentTender.summary.percentageIncrease) + '%'
                });
                
            } catch (error) {
                console.error('❌ 計算本地統計失敗:', error);
                // 設定預設值
                currentTender.summary = {
                    originalAmount: 0,
                    additionAmount: 0,
                    totalAmount: 0,
                    percentageIncrease: 0
                };
            }
        }

        // 顯示標單基本資訊
        function displayTenderInfo() {
            document.getElementById('tenderName').textContent = currentTender.name || '未命名';
            document.getElementById('contractorName').textContent = currentTender.contractorName || '未指定';
            
            if (currentTender.summary) {
                const summary = currentTender.summary;
                document.getElementById('originalAmount').textContent = formatCurrency(summary.originalAmount);
                document.getElementById('additionAmount').textContent = formatCurrency(summary.additionAmount);
                document.getElementById('totalAmount').textContent = formatCurrency(summary.totalAmount);
                document.getElementById('increasePercentage').textContent = Math.round(summary.percentageIncrease) + '%';
            }
        }

        // 顯示原始項目
        function displayOriginalItems() {
            const tbody = document.getElementById('originalItemsTable');
            tbody.innerHTML = '';
            
            originalItems.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'readonly';
                
                // 計算目前總數量（含追加）
                const relatedAdditions = additionItems.filter(add => add.relatedDetailItemId === item.id);
                const additionQty = relatedAdditions.reduce((sum, add) => sum + (add.additionQuantity || 0), 0);
                const currentTotalQty = (item.totalQuantity || item.quantity || 0) + additionQty;
                
                row.innerHTML = `
                    <td>${item.majorItemName}</td>
                    <td>
                        ${item.name}
                        <span class="original-tag">原始項目</span>
                    </td>
                    <td>${item.totalQuantity || item.quantity || 0}</td>
                    <td>${item.unit || ''}</td>
                    <td>${formatCurrency(item.unitPrice || 0)}</td>
                    <td>${formatCurrency(item.totalPrice || 0)}</td>
                    <td><strong>${currentTotalQty}</strong> ${additionQty > 0 ? `(+${additionQty})` : ''}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="addQuantityToItem('${item.id}', '${item.name}')">
                            ➕ 追加數量
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // 顯示追加項目
        function displayAdditionItems() {
            const tbody = document.getElementById('additionItemsTable');
            const noMessage = document.getElementById('noAdditionsMessage');
            
            tbody.innerHTML = '';
            
            if (additionItems.length === 0) {
                noMessage.style.display = 'block';
                return;
            }
            
            noMessage.style.display = 'none';
            
            additionItems.forEach(item => {
                const row = document.createElement('tr');
                
                // 找到關聯的原始項目
                const relatedItem = originalItems.find(orig => orig.id === item.relatedDetailItemId);
                const relatedItemName = relatedItem ? relatedItem.name : '已刪除項目';
                
                row.innerHTML = `
                    <td>${formatDate(item.additionDate)}</td>
                    <td>
                        ${relatedItemName}
                        <span class="addition-tag">追加項目</span>
                    </td>
                    <td>${item.additionQuantity || 0} ${item.unit || ''}</td>
                    <td>${formatCurrency(item.additionUnitPrice || 0)}</td>
                    <td>${formatCurrency(item.additionTotalPrice || 0)}</td>
                    <td>${item.additionReason || ''}</td>
                    <td>
                        <span style="color: ${item.additionApproved ? '#28a745' : '#ffc107'};">
                            ${item.additionApproved ? '✅ 已核准' : '⏳ 待核准'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editAdditionItem('${item.id}')">
                            編輯
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteAdditionItemConfirm('${item.id}')">
                            刪除
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // 顯示統計卡片
        function displaySummaryCards() {
            const grid = document.getElementById('summaryGrid');
            grid.innerHTML = '';
            
            // 按項目分組統計
            const itemGroups = new Map();
            
            // 先建立所有原始項目的基礎資料
            originalItems.forEach(item => {
                const key = item.name;
                if (!itemGroups.has(key)) {
                    itemGroups.set(key, {
                        name: key,
                        unit: item.unit || '',
                        originalQuantity: 0,
                        additionQuantity: 0,
                        originalAmount: 0,
                        additionAmount: 0,
                        hasAdditions: false
                    });
                }
                
                const group = itemGroups.get(key);
                group.originalQuantity += item.totalQuantity || item.quantity || 0;
                group.originalAmount += item.totalPrice || 0;
            });
            
            // 計算追加項目的統計
            additionItems.forEach(item => {
                const relatedItem = originalItems.find(orig => orig.id === item.relatedDetailItemId);
                if (relatedItem) {
                    const key = relatedItem.name;
                    if (itemGroups.has(key)) {
                        const group = itemGroups.get(key);
                        group.additionQuantity += item.additionQuantity || 0;
                        group.additionAmount += item.additionTotalPrice || 0;
                        group.hasAdditions = true; // 標記為有追加
                    }
                }
            });
            
            // 🎯 只顯示有追加項目的統計卡片
            const itemsWithAdditions = Array.from(itemGroups.values()).filter(group => group.hasAdditions);
            
            if (itemsWithAdditions.length === 0) {
                // 如果沒有任何追加項目，顯示提示訊息
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #6c757d;">
                        <div style="font-size: 48px; margin-bottom: 15px;">📊</div>
                        <div style="font-size: 18px; margin-bottom: 10px;">目前沒有追加項目</div>
                        <small>新增追加項目後，這裡會顯示數量對比統計</small>
                    </div>
                `;
                return;
            }
            
            // 生成有追加項目的統計卡片
            itemsWithAdditions.forEach(group => {
                const card = document.createElement('div');
                card.className = 'summary-card';
                
                const totalQuantity = group.originalQuantity + group.additionQuantity;
                const totalAmount = group.originalAmount + group.additionAmount;
                const increasePercentage = group.originalQuantity > 0 ? 
                    Math.round((group.additionQuantity / group.originalQuantity) * 100) : 0;
                
                card.innerHTML = `
                    <div class="summary-item-name">
                        ${group.name}
                        <span style="color: #ffc107; font-size: 12px; margin-left: 8px;">
                            +${increasePercentage}%
                        </span>
                    </div>
                    <div class="summary-detail">
                        <span>原始數量:</span>
                        <span>${group.originalQuantity} ${group.unit}</span>
                    </div>
                    <div class="summary-detail">
                        <span>追加數量:</span>
                        <span style="color: #ffc107; font-weight: 600;">+${group.additionQuantity} ${group.unit}</span>
                    </div>
                    <div class="summary-detail">
                        <span><strong>總計數量:</strong></span>
                        <span><strong style="color: #667eea;">${totalQuantity} ${group.unit}</strong></span>
                    </div>
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e9ecef; font-size: 12px; color: #666;">
                        金額增加: ${formatCurrency(group.additionAmount)}
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }

        // 設定事件監聽器
        function setupEventListeners() {
            // 追加項目表單提交
            document.getElementById('additionForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await submitAdditionForm();
            });
            
            // 設定今天的日期為預設值
            document.getElementById('additionDate').value = new Date().toISOString().split('T')[0];
            
            // 監聽關聯項目變更
            document.getElementById('relatedDetailItem').addEventListener('change', onRelatedItemChange);
        }

        // 顯示追加 Modal
        function showAdditionModal(preSelectedItemId = null) {
            const modal = document.getElementById('additionModal');
            const select = document.getElementById('relatedDetailItem');
            
            // 填充原始項目選項
            select.innerHTML = '<option value="">請選擇要追加的原始項目</option>';
            originalItems.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `${item.majorItemName} - ${item.name} (目前: ${item.totalQuantity || item.quantity || 0} ${item.unit || ''})`;
                select.appendChild(option);
            });
            
            // 如果有預選項目
            if (preSelectedItemId) {
                select.value = preSelectedItemId;
                onRelatedItemChange(); // 自動填入單價
            }
            
            // 重設表單狀態
            const submitBtn = document.querySelector('#additionForm button[type="submit"]');
            submitBtn.innerHTML = '➕ 新增追加項目';
            submitBtn.onclick = null;
            
            modal.style.display = 'block';
        }

        // 關閉追加 Modal
        function closeAdditionModal() {
            document.getElementById('additionModal').style.display = 'none';
            document.getElementById('additionForm').reset();
        }

        // 當選擇關聯項目時，自動填入建議單價
        function onRelatedItemChange() {
            const select = document.getElementById('relatedDetailItem');
            const unitPriceInput = document.getElementById('additionUnitPrice');
            
            if (select.value) {
                const selectedItem = originalItems.find(item => item.id === select.value);
                if (selectedItem) {
                    unitPriceInput.value = selectedItem.unitPrice || 0;
                }
            }
        }

        // 🚀 提交追加項目表單（強化版 - 包含手動更新）
        async function submitAdditionForm() {
            try {
                showLoading(true, '新增追加項目...');
                
                const formData = {
                    relatedDetailItemId: document.getElementById('relatedDetailItem').value,
                    tenderId: currentTender.id,
                    additionQuantity: parseInt(document.getElementById('additionQuantity').value),
                    additionUnitPrice: parseFloat(document.getElementById('additionUnitPrice').value),
                    additionReason: document.getElementById('additionReason').value.trim(),
                    additionDate: document.getElementById('additionDate').value ? 
                        new Date(document.getElementById('additionDate').value + 'T00:00:00') : 
                        new Date(),
                    approvedBy: document.getElementById('approvedBy').value.trim(),
                    notes: document.getElementById('additionNotes').value.trim(),
                    additionApproved: false // 預設為待核准
                };
                
                // 找到關聯項目的資訊
                const relatedItem = originalItems.find(item => item.id === formData.relatedDetailItemId);
                if (relatedItem) {
                    formData.majorItemId = relatedItem.majorItemId;
                    formData.name = relatedItem.name;
                    formData.unit = relatedItem.unit;
                }
                
                let newItemData = null;
                
                // 🎯 關鍵操作：增量更新
                if (typeof createAdditionItem === 'function') {
                    // 使用增強版函數（會自動觸發即時監聽）
                    const additionId = await createAdditionItem(formData);
                    console.log('✅ 使用增強版函數新增追加項目:', additionId);
                    
                    // 手動建立新項目資料以備用
                    newItemData = {
                        id: additionId,
                        ...formData,
                        additionTotalPrice: formData.additionQuantity * formData.additionUnitPrice,
                        createdBy: currentUser.email,
                        createdAt: new Date()
                    };
                } else {
                    // 直接使用 Firestore 新增（會觸發即時監聽）
                    console.log('⚠️ 使用直接 Firestore 新增方法');
                    const additionData = {
                        ...formData,
                        additionTotalPrice: formData.additionQuantity * formData.additionUnitPrice,
                        createdBy: currentUser.email,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    const docRef = await db.collection('additionItems').add(additionData);
                    
                    // 手動建立新項目資料以備用
                    newItemData = {
                        id: docRef.id,
                        ...formData,
                        additionTotalPrice: formData.additionQuantity * formData.additionUnitPrice,
                        createdBy: currentUser.email,
                        createdAt: new Date()
                    };
                }
                
                // 🚀 備用機制：如果即時監聽沒觸發，手動更新
                setTimeout(() => {
                    if (newItemData && !additionItems.find(item => item.id === newItemData.id)) {
                        console.log('⚠️ 即時監聽未觸發，手動新增項目到本地陣列');
                        additionItems.unshift(newItemData);
                        updateDisplayAfterChange();
                    }
                }, 1000); // 1秒後檢查
                
                closeAdditionModal();
                showLoading(false);
                showAlert('追加項目新增成功！', 'success');
                
            } catch (error) {
                console.error('❌ 新增追加項目失敗:', error);
                showAlert('新增追加項目失敗: ' + error.message, 'error');
                showLoading(false);
            }
        }

        // 快速追加數量到指定項目
        function addQuantityToItem(itemId, itemName) {
            showAdditionModal(itemId);
            
            // 設定預設追加原因
            setTimeout(() => {
                document.getElementById('additionReason').value = `${itemName} 數量追加`;
                document.getElementById('additionQuantity').focus();
            }, 100);
        }

        // 編輯追加項目
        function editAdditionItem(additionId) {
            const addition = additionItems.find(item => item.id === additionId);
            if (!addition) {
                showAlert('找不到追加項目', 'error');
                return;
            }
            
            // 填入現有資料到表單
            showAdditionModal(addition.relatedDetailItemId);
            
            setTimeout(() => {
                document.getElementById('additionQuantity').value = addition.additionQuantity || '';
                document.getElementById('additionUnitPrice').value = addition.additionUnitPrice || '';
                document.getElementById('additionReason').value = addition.additionReason || '';
                document.getElementById('approvedBy').value = addition.approvedBy || '';
                document.getElementById('additionNotes').value = addition.notes || '';
                
                if (addition.additionDate) {
                    const date = addition.additionDate.toDate ? addition.additionDate.toDate() : new Date(addition.additionDate);
                    document.getElementById('additionDate').value = date.toISOString().split('T')[0];
                }
                
                // 修改提交按鈕
                const submitBtn = document.querySelector('#additionForm button[type="submit"]');
                submitBtn.innerHTML = '💾 更新追加項目';
                submitBtn.onclick = (e) => {
                    e.preventDefault();
                    updateAdditionItemAction(additionId);
                };
            }, 100);
        }

        // 🚀 更新追加項目（優化版）
        async function updateAdditionItemAction(additionId) {
            try {
                showLoading(true, '更新追加項目...');
                
                const updateData = {
                    additionQuantity: parseInt(document.getElementById('additionQuantity').value),
                    additionUnitPrice: parseFloat(document.getElementById('additionUnitPrice').value),
                    additionReason: document.getElementById('additionReason').value.trim(),
                    additionDate: document.getElementById('additionDate').value ? 
                        new Date(document.getElementById('additionDate').value + 'T00:00:00') : 
                        new Date(),
                    approvedBy: document.getElementById('approvedBy').value.trim(),
                    notes: document.getElementById('additionNotes').value.trim()
                };
                
                // 🎯 關鍵操作：增量更新
                if (typeof updateAdditionItem === 'function') {
                    // 使用增強版函數
                    await updateAdditionItem(additionId, updateData);
                    console.log('✅ 使用增強版函數更新追加項目');
                } else {
                    // 直接使用 Firestore 更新
                    console.log('⚠️ 使用直接 Firestore 更新方法');
                    updateData.additionTotalPrice = updateData.additionQuantity * updateData.additionUnitPrice;
                    updateData.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                    
                    await db.collection('additionItems').doc(additionId).update(updateData);
                }
                
                // 🎯 不需要重新載入，即時監聽會自動更新！
                closeAdditionModal();
                showLoading(false);
                showAlert('追加項目更新成功！即時同步中...', 'success');
                
            } catch (error) {
                console.error('❌ 更新追加項目失敗:', error);
                showAlert('更新追加項目失敗: ' + error.message, 'error');
                showLoading(false);
            }
        }

        // 確認刪除追加項目
        function deleteAdditionItemConfirm(additionId) {
            const addition = additionItems.find(item => item.id === additionId);
            if (!addition) {
                showAlert('找不到追加項目', 'error');
                return;
            }
            
            const relatedItem = originalItems.find(orig => orig.id === addition.relatedDetailItemId);
            const itemName = relatedItem ? relatedItem.name : '未知項目';
            
            if (confirm(`確定要刪除這個追加項目嗎？\n\n項目：${itemName}\n數量：${addition.additionQuantity} ${addition.unit || ''}\n金額：${formatCurrency(addition.additionTotalPrice)}\n\n此操作無法復原！`)) {
                deleteAdditionItemAction(additionId);
            }
        }

        // 🚀 執行刪除追加項目（優化版）
        async function deleteAdditionItemAction(additionId) {
            try {
                showLoading(true, '刪除追加項目...');
                
                // 🎯 關鍵操作：增量更新
                if (typeof deleteAdditionItem === 'function') {
                    // 使用增強版函數
                    await deleteAdditionItem(additionId);
                    console.log('✅ 使用增強版函數刪除追加項目');
                } else {
                    // 直接使用 Firestore 刪除
                    console.log('⚠️ 使用直接 Firestore 刪除方法');
                    await db.collection('additionItems').doc(additionId).delete();
                }
                
                // 🎯 不需要重新載入，即時監聽會自動更新！
                showLoading(false);
                showAlert('追加項目已刪除！即時同步中...', 'success');
                
            } catch (error) {
                console.error('❌ 刪除追加項目失敗:', error);
                showAlert('刪除追加項目失敗: ' + error.message, 'error');
                showLoading(false);
            }
        }

        // 顯示載入動畫
        function showLoading(show, text = '載入中...') {
            const loadingSection = document.getElementById('loadingSection');
            const loadingText = document.getElementById('loadingText');
            
            if (show) {
                loadingSection.style.display = 'block';
                loadingText.textContent = text;
            } else {
                loadingSection.style.display = 'none';
            }
        }

        // 顯示提示訊息
        function showAlert(message, type = 'info') {
            const alertMessage = document.getElementById('alertMessage');
            alertMessage.textContent = message;
            alertMessage.className = 'alert ' + type;
            alertMessage.style.display = 'block';
            
            setTimeout(() => {
                alertMessage.style.display = 'none';
            }, 5000);
        }

        // 導航功能
        function goToDashboard() {
            window.location.href = '../dashboard.html';
        }

        // 登出功能
        async function logout() {
            if (confirm('確定要登出嗎？')) {
                try {
                    await auth.signOut();
                    window.location.href = '../login_page.html';
                } catch (error) {
                    console.error('登出失敗:', error);
                    showAlert('登出失敗，請重試', 'error');
                }
            }
        }

        // 點擊 Modal 外部關閉
        window.onclick = function(event) {
            const modal = document.getElementById('additionModal');
            if (event.target === modal) {
                closeAdditionModal();
            }
        }
    </script>
</body>
</html>